<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zachary's Weaning Tracker</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #ff9a9e, #fecfef); min-height: 100vh; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 30px; text-align: center; }
        .header-logo { max-width: 600px; max-height: 240px; width: auto; height: auto; margin-bottom: 15px; object-fit: contain; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .header p { font-size: 1.1rem; opacity: 0.9; }
        .user-info { position: absolute; top: 15px; right: 15px; color: white; font-size: 0.9rem; }
        .logout-btn { background: rgba(255,255,255,0.2); color: white; border: none; padding: 5px 10px; border-radius: 15px; cursor: pointer; margin-left: 10px; }
        .logout-btn:hover { background: rgba(255,255,255,0.3); }
        .tabs { display: flex; background: #f8f9fa; border-bottom: 2px solid #dee2e6; }
        .tab { flex: 1; padding: 15px; text-align: center; background: none; border: none; cursor: pointer; font-size: 1rem; font-weight: bold; color: #6c757d; transition: all 0.3s ease; }
        .tab.active { color: #667eea; background: white; border-bottom: 3px solid #667eea; }
        .tab:hover { background: #e9ecef; color: #495057; }
        .content { padding: 20px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .summary-card { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .summary-number { font-size: 2.5rem; font-weight: bold; margin-bottom: 10px; }
        .summary-label { font-size: 1rem; opacity: 0.9; }
        .progress-bar { background: #e9ecef; border-radius: 20px; height: 30px; overflow: hidden; margin: 20px 0; position: relative; }
        .progress-fill { background: linear-gradient(135deg, #28a745, #20c997); height: 100%; transition: width 0.5s ease; border-radius: 20px; }
        .progress-text { position: absolute; width: 100%; text-align: center; line-height: 30px; font-weight: bold; color: #495057; }
        .controls { display: flex; gap: 10px; justify-content: center; margin: 20px 0; flex-wrap: wrap; }
        .export-btn, .import-btn { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-weight: bold; transition: all 0.3s ease; }
        .export-btn:hover, .import-btn:hover { background: #0056b3; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,123,255,0.3); }
        .stage { margin-bottom: 25px; border-radius: 15px; background: white; box-shadow: 0 5px 15px rgba(0,0,0,0.1); overflow: hidden; }
        .stage-header { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; cursor: pointer; transition: all 0.3s ease; display: flex; justify-content: space-between; align-items: center; }
        .stage-header:hover { background: linear-gradient(135deg, #5a67d8, #6b46c1); }
        .stage-header h3 { font-size: 1.3rem; }
        .stage-progress { font-size: 0.9rem; opacity: 0.9; }
        .stage-content { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; padding: 25px; background: #f8f9fa; }
        .food-item { background: white; padding: 20px; border-radius: 12px; border: 2px solid #e9ecef; transition: all 0.3s ease; position: relative; }
        .food-item:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .food-item.allergy-flagged { border-color: #ffc107; background: #fffbf0; }
        .food-name { font-weight: bold; font-size: 1.1rem; margin-bottom: 15px; color: #495057; }
        .allergy-flag { position: absolute; top: 10px; right: 10px; background: #ffc107; color: #212529; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; cursor: pointer; }
        .food-controls { display: flex; flex-direction: column; gap: 10px; }
        .tried-container { display: flex; align-items: center; gap: 10px; }
        .tried-checkbox { width: 20px; height: 20px; cursor: pointer; }
        .counter-container { display: flex; align-items: center; gap: 10px; }
        .counter-btn { background: #667eea; color: white; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; font-weight: bold; transition: all 0.3s ease; }
        .counter-btn:hover { background: #5a67d8; transform: scale(1.1); }
        .counter-display { font-size: 1.2rem; font-weight: bold; color: #495057; min-width: 30px; text-align: center; }
        .rating-container { display: flex; gap: 5px; align-items: center; }
        .star { font-size: 1.5rem; cursor: pointer; transition: all 0.3s ease; filter: grayscale(100%); }
        .star.filled { filter: none; }
        .star:hover { transform: scale(1.2); }
        .allergy-btn { background: #ffc107; color: #212529; border: none; padding: 8px 12px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; margin-top: 10px; }
        .allergy-btn:hover { background: #e0a800; }
        .notes-section { background: white; padding: 20px; margin-top: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .notes-section h3 { color: #495057; margin-bottom: 15px; }
        .notes-textarea { width: 100%; height: 100px; border: 2px solid #e9ecef; border-radius: 10px; padding: 15px; font-family: inherit; resize: vertical; }
        .notes-textarea:focus { outline: none; border-color: #667eea; }
        .auto-save-indicator { position: fixed; bottom: 20px; right: 20px; background: #28a745; color: white; padding: 10px 15px; border-radius: 20px; font-size: 0.9rem; opacity: 0; transition: opacity 0.3s ease; }
        .auto-save-indicator.show { opacity: 1; }
        .add-meal-section { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin: 20px 0; }
        .add-meal-section h3 { color: #495057; margin-bottom: 25px; font-size: 1.5rem; text-align: center; }
        .stage-selector { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stage-option { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 2px solid #dee2e6; border-radius: 12px; padding: 15px; text-align: center; font-weight: 600; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden; }
        .stage-option:hover { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 182, 193, 0.4); }
        .stage-option.selected { background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%); color: white; transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 107, 107, 0.5); border: 2px solid #ff4757; }
        .meal-input-section { display: flex; gap: 15px; align-items: center; margin-bottom: 20px; }
        .meal-input { flex: 1; padding: 12px 20px; border: 2px solid #dee2e6; border-radius: 25px; font-size: 1rem; transition: all 0.3s ease; background: white; }
        .meal-input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .add-meal-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 25px; border-radius: 25px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; white-space: nowrap; }
        .add-meal-btn:hover:not(:disabled) { background: linear-gradient(135deg, #5a6fd8 0%, #6a4c93 100%); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3); }
        .add-meal-btn:disabled { background: #6c757d; cursor: not-allowed; opacity: 0.6; }
        .loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255,255,255,0.9); padding: 20px; border-radius: 10px; z-index: 1000; }

        /* Login Screen */
        .login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #ff9a9e, #fecfef); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .login-container { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); max-width: 400px; width: 90%; }
        .login-title { text-align: center; margin-bottom: 30px; color: #495057; }
        .login-form { display: flex; flex-direction: column; gap: 15px; }
        .login-input { padding: 15px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 1rem; }
        .login-input:focus { outline: none; border-color: #667eea; }
        .login-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 15px; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; }
        .login-btn:hover { background: linear-gradient(135deg, #5a6fd8 0%, #6a4c93 100%); }
        .register-toggle { text-align: center; margin-top: 15px; color: #6c757d; cursor: pointer; }
        .register-toggle:hover { color: #495057; }

        /* Achievement Popup */
        .achievement-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 20px; box-shadow: 0 15px 40px rgba(0,0,0,0.3); z-index: 3000; text-align: center; max-width: 400px; width: 90%; }
        .achievement-icon { font-size: 4rem; margin-bottom: 15px; }
        .achievement-title { font-size: 1.5rem; font-weight: bold; color: #495057; margin-bottom: 10px; }
        .achievement-desc { color: #6c757d; margin-bottom: 20px; }
        .achievement-close { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; }

        /* Allergy Modal */
        .allergy-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 3000; }
        .allergy-modal-content { background: white; padding: 30px; border-radius: 20px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .allergy-symptoms { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 20px 0; }
        .symptom-option { background: #f8f9fa; border: 2px solid #dee2e6; padding: 10px; border-radius: 10px; cursor: pointer; text-align: center; transition: all 0.3s ease; }
        .symptom-option.selected { background: #fffbf0; border-color: #ffc107; color: #856404; }
        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .modal-btn { padding: 10px 20px; border: none; border-radius: 25px; cursor: pointer; font-weight: 600; }
        .modal-btn.save { background: #ffc107; color: #212529; }
        .modal-btn.cancel { background: #6c757d; color: white; }

        @media (max-width: 768px) { 
            .header { padding: 20px 15px; text-align: center; }
            .header h1 { font-size: 1.8rem; } 
            .header-logo { width: calc(100% - 30px); max-width: calc(100vw - 70px); height: auto; max-height: 20vh; object-fit: contain; display: block; margin: 0 auto 15px auto; } 
            .user-info { position: static; margin-bottom: 15px; }
            .summary-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); } 
            .stage-content { grid-template-columns: 1fr; } 
            .controls { flex-direction: column; align-items: center; } 
            .stage-selector { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; } 
            .stage-option { padding: 10px; font-size: 0.9rem; } 
            .meal-input-section { flex-direction: column; align-items: stretch; } 
            .add-meal-btn { width: 100%; margin-top: 10px; } 
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-container">
            <h2 class="login-title">üçº Weaning Tracker</h2>
            <div class="login-form">
                <input type="text" id="loginUsername" class="login-input" placeholder="Username" maxlength="30">
                <input type="password" id="loginPassword" class="login-input" placeholder="Password" maxlength="30">
                <button id="loginBtn" class="login-btn">Login</button>
                <div class="register-toggle" id="registerToggle">Don't have an account? Register here</div>
            </div>
        </div>
    </div>

    <!-- Achievement Popup -->
    <div id="achievementPopup" class="achievement-popup" style="display: none;">
        <div class="achievement-icon" id="achievementIcon">üèÜ</div>
        <div class="achievement-title" id="achievementTitle">Achievement Unlocked!</div>
        <div class="achievement-desc" id="achievementDesc">You've reached a milestone!</div>
        <button class="achievement-close" onclick="closeAchievement()">Awesome!</button>
    </div>

    <!-- Allergy Modal -->
    <div id="allergyModal" class="allergy-modal" style="display: none;">
        <div class="allergy-modal-content">
            <h3>‚ö†Ô∏è Report Allergic Reaction</h3>
            <p>Food: <strong id="allergyFoodName"></strong></p>
            <div id="allergyHistory" style="display: none; background: #fffbf0; border: 2px solid #ffc107; border-radius: 10px; padding: 15px; margin: 15px 0;">
                <h4 style="color: #856404; margin-bottom: 10px;">Previous Reactions:</h4>
                <div id="allergyHistoryList"></div>
            </div>
            <div class="allergy-symptoms">
                <div class="symptom-option" data-symptom="rash">Skin rash/hives</div>
                <div class="symptom-option" data-symptom="swelling">Swelling (face/lips)</div>
                <div class="symptom-option" data-symptom="breathing">Breathing difficulty</div>
                <div class="symptom-option" data-symptom="vomiting">Vomiting</div>
                <div class="symptom-option" data-symptom="diarrhea">Diarrhea</div>
                <div class="symptom-option" data-symptom="fussiness">Excessive fussiness</div>
                <div class="symptom-option" data-symptom="other">Other symptoms</div>
            </div>
            <textarea id="allergyNotes" placeholder="Additional notes about the reaction..." rows="3" style="width: 100%; margin: 10px 0; padding: 10px; border: 2px solid #dee2e6; border-radius: 10px;"></textarea>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeAllergyModal()">Cancel</button>
                <button class="modal-btn save" onclick="saveAllergyReport()">Report Reaction</button>
            </div>
        </div>
    </div>

    <div id="loading" class="loading" style="display: none;">
        <div>üîÑ Syncing data...</div>
    </div>

    <div class="container" id="mainApp" style="display: none;">
        <div class="header">
            <div class="user-info">
                üë§ <span id="currentUser"></span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
            <img src="this.png" alt="Zachary's Weaning Tracker" class="header-logo">
            <p>Track every taste, every try, every triumph!</p>
        </div>
        <div class="tabs">
            <button class="tab active" onclick="switchTab('summary')">üìä Summary</button>
            <button class="tab" onclick="switchTab('stages')">üìÖ Stages</button>
            <button class="tab" onclick="switchTab('addMeal')">‚ûï Add Meal</button>
        </div>
        <div class="content">
            <div id="summary" class="tab-content active">
                <div class="summary-grid">
                    <div class="summary-card"><div class="summary-number" id="totalTried">0</div><div class="summary-label">Foods Tried</div></div>
                    <div class="summary-card"><div class="summary-number" id="totalAttempts">0</div><div class="summary-label">Total Attempts</div></div>
                    <div class="summary-card"><div class="summary-number" id="avgRating">0</div><div class="summary-label">Average Rating</div></div>
                    <div class="summary-card"><div class="summary-number" id="favoriteFoods">0</div><div class="summary-label">5-Star Foods</div></div>
                </div>
                <div class="progress-bar"><div class="progress-fill" id="progressBar"></div><div class="progress-text" id="progressText">0% Complete</div></div>
                <div class="controls">
                    <button class="export-btn" onclick="exportData()">üì• Export Data</button>
                    <button class="import-btn" onclick="importData()">üì§ Import Data</button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImport(this)">
                </div>
                <div class="notes-section"><h3>üìù Notes</h3><textarea class="notes-textarea" id="notesArea" placeholder="Add any notes about Zachary's weaning journey..."></textarea></div>
            </div>
            <div id="stages" class="tab-content"><div id="stagesContainer"></div></div>
            <div id="addMeal" class="tab-content">
                <div class="add-meal-section">
                    <h3>Add Custom Meal</h3>
                    <p style="text-align: center; margin-bottom: 25px; color: #6c757d;">Add a custom food for Zachary and choose which weaning stage it belongs to.</p>
                    <div class="stage-selector">
                        <div class="stage-option" data-stage="Week 1-2: First Tastes"><strong>Week 1-2</strong><br>First Tastes</div>
                        <div class="stage-option" data-stage="Week 3-4: Building Confidence"><strong>Week 3-4</strong><br>Building Confidence</div>
                        <div class="stage-option" data-stage="Week 5-6: Introducing Lumps"><strong>Week 5-6</strong><br>Introducing Lumps</div>
                        <div class="stage-option" data-stage="Week 7-10: Variety & Textures"><strong>Week 7-10</strong><br>Variety & Textures</div>
                        <div class="stage-option" data-stage="Week 11-16: Chopped & Chunkier"><strong>Week 11-16</strong><br>Chopped & Chunkier</div>
                        <div class="stage-option" data-stage="Month 9-12: Joining Family Meals"><strong>Month 9-12</strong><br>Joining Family Meals</div>
                    </div>
                    <div class="meal-input-section">
                        <input type="text" id="mealName" class="meal-input" placeholder="Enter custom meal name (e.g., 'Homemade applesauce')" maxlength="50">
                        <button id="addMealBtn" class="add-meal-btn" disabled>Add Meal</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="auto-save-indicator" id="autoSaveIndicator">‚úÖ Synced to cloud!</div>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
        import { getDatabase, ref, onValue, set, push, get } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js';

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCFGP2fcznEA_ubCtcWpQT4Ny99R7U4vHY",
            authDomain: "zachary-weaning.firebaseapp.com",
            databaseURL: "https://zachary-weaning-default-rtdb.firebaseio.com",
            projectId: "zachary-weaning",
            storageBucket: "zachary-weaning.firebasestorage.app",
            messagingSenderId: "135558156277",
            appId: "1:135558156277:web:97055f024492f3a7879abc",
            measurementId: "G-3WWJ4G6XEC"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Global variables
        let currentUser = null;
        let currentUserData = {};
        let isRegistering = false;
        let allergyModalData = {};
        let achievementQueue = [];

        // Weaning stages data (mutable for custom meals)
        let weaningStages = {
            "Week 1-2: First Tastes": ["Apple puree", "Banana", "Carrot puree", "Sweet potato", "Pear puree", "Broccoli puree", "Butternut squash", "Avocado", "Baby rice", "Parsnip puree"],
            "Week 3-4: Building Confidence": ["Cauliflower puree", "Courgette puree", "Mango puree", "Peach puree", "Green beans puree", "Pumpkin puree", "Spinach puree", "Potato puree", "Papaya puree", "Beetroot puree"],
            "Week 5-6: Introducing Lumps": ["Mashed banana", "Well-cooked pasta shapes", "Soft cooked apple pieces", "Mashed sweet potato with lumps", "Soft steamed broccoli florets", "Mashed avocado with texture", "Soft cooked carrot sticks", "Rice with soft vegetables", "Mashed potato with lumps", "Soft cooked pear pieces"],
            "Week 7-10: Variety & Textures": ["Scrambled egg", "Soft cooked chicken strips", "Toast fingers", "Cheese cubes", "Soft cooked fish flakes", "Pasta with sauce", "Steamed vegetable sticks", "Soft fruits in pieces", "Rice cakes", "Yogurt", "Well-cooked lentils", "Soft cooked beef strips"],
            "Week 11-16: Chopped & Chunkier": ["Chopped chicken", "Chopped vegetables", "Harder fruits", "Sandwich pieces", "Mini meatballs", "Chopped hard-boiled egg", "Pasta salad", "Roasted vegetables", "Grated cheese", "Chopped fish", "Bean salads", "Finger foods"],
            "Month 9-12: Joining Family Meals": ["Family meal portions", "Whole fruits", "Raw vegetables", "Nuts (chopped/ground)", "Whole grains", "Spiced foods", "Mixed textures", "Self-feeding foods", "Cup drinking", "Family snacks", "Complex meals", "Adult portions (smaller)"]
        };

        // Data storage
        let weaningData = {};
        let allergyData = {};
        let notes = '';
        let selectedStage = null;
        let achievements = {};

        // Achievement definitions
        const achievementList = {
            firstFood: { icon: 'üçé', title: 'First Bite!', desc: 'Tried your very first food!', trigger: (data) => getTotalTried(data) === 1 },
            fiveFoods: { icon: 'üåà', title: 'Food Explorer!', desc: 'Tried 5 different foods!', trigger: (data) => getTotalTried(data) === 5 },
            tenFoods: { icon: 'üèÜ', title: 'Taste Adventurer!', desc: 'Tried 10 different foods!', trigger: (data) => getTotalTried(data) === 10 },
            twentyFoods: { icon: 'üéñÔ∏è', title: 'Super Taster!', desc: 'Tried 20 different foods!', trigger: (data) => getTotalTried(data) === 20 },
            firstLove: { icon: '‚ù§Ô∏è', title: 'Found a Favorite!', desc: 'Gave your first 5-star rating!', trigger: (data) => getFiveStarCount(data) === 1 },
            fiveLoves: { icon: 'üíù', title: 'Food Lover!', desc: 'Found 5 favorite foods!', trigger: (data) => getFiveStarCount(data) === 5 },
            persistent: { icon: 'üí™', title: 'Never Give Up!', desc: 'Tried the same food 5 times!', trigger: (data) => hasRepeatedFood(data, 5) },
            champion: { icon: 'ü•á', title: 'Weaning Champion!', desc: 'Tried 50 different foods!', trigger: (data) => getTotalTried(data) === 50 }
        };

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            setupLoginSystem();
        });

        // Login System
        function setupLoginSystem() {
            // Auto-login Zachary for existing data
            const savedUser = localStorage.getItem('weaningUser');
            if (savedUser === 'Zachary') {
                currentUser = 'Zachary';
                document.getElementById('currentUser').textContent = currentUser;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                loadFromFirebase();
                setupAddMealTab();
                setupRealtimeListeners();
            }

            document.getElementById('loginBtn').addEventListener('click', handleLogin);
            document.getElementById('registerToggle').addEventListener('click', toggleRegister);
        }

        function toggleRegister() {
            isRegistering = !isRegistering;
            const btn = document.getElementById('loginBtn');
            const toggle = document.getElementById('registerToggle');
            
            if (isRegistering) {
                btn.textContent = 'Register';
                toggle.textContent = 'Already have an account? Login here';
            } else {
                btn.textContent = 'Login';
                toggle.textContent = "Don't have an account? Register here";
            }
        }

        async function handleLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();

            if (!username || !password) {
                alert('Please enter both username and password');
                return;
            }

            showLoading(true);

            try {
                const userRef = ref(database, `users/${username}`);
                const userSnapshot = await get(userRef);

                if (isRegistering) {
                    if (userSnapshot.exists()) {
                        alert('Username already exists! Please choose a different one.');
                        showLoading(false);
                        return;
                    }
                    
                    // Create new user
                    await set(userRef, {
                        password: password,
                        createdAt: new Date().toISOString(),
                        weaningData: {},
                        allergyData: {},
                        notes: '',
                        achievements: {}
                    });
                    
                    currentUser = username;
                    showAutoSave(`‚úÖ Account created for ${username}!`);
                } else {
                    if (!userSnapshot.exists()) {
                        alert('User not found! Please register first.');
                        showLoading(false);
                        return;
                    }

                    const userData = userSnapshot.val();
                    if (userData.password !== password) {
                        alert('Incorrect password!');
                        showLoading(false);
                        return;
                    }

                    currentUser = username;
                }

                // Save login state and switch to main app
                localStorage.setItem('weaningUser', currentUser);
                document.getElementById('currentUser').textContent = currentUser;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                
                loadFromFirebase();
                setupAddMealTab();
                setupRealtimeListeners();
                showLoading(false);

            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed. Please try again.');
                showLoading(false);
            }
        }

        window.logout = function() {
            currentUser = null;
            localStorage.removeItem('weaningUser');
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            weaningData = {};
            allergyData = {};
            notes = '';
            achievements = {};
        }

        // Load data from Firebase
        async function loadFromFirebase() {
            if (!currentUser) return;
            
            showLoading(true);
            try {
                const userRef = ref(database, `users/${currentUser}`);
                const userSnapshot = await get(userRef);
                
                if (userSnapshot.exists()) {
                    currentUserData = userSnapshot.val();
                    weaningData = currentUserData.weaningData || {};
                    allergyData = currentUserData.allergyData || {};
                    notes = currentUserData.notes || '';
                    achievements = currentUserData.achievements || {};
                    
                    if (currentUserData.customStages) {
                        weaningStages = { ...weaningStages, ...currentUserData.customStages };
                    }

                    document.getElementById('notesArea').value = notes;
                }

                renderStages();
                updateSummary();
                setupNotesListener();
                showLoading(false);
            } catch (error) {
                console.error('Error loading from Firebase:', error);
                showLoading(false);
                showAutoSave('‚ùå Connection error - using local data');
            }
        }

        // Setup realtime listeners for changes
        function setupRealtimeListeners() {
            if (!currentUser) return;

            const userRef = ref(database, `users/${currentUser}`);
            onValue(userRef, (snapshot) => {
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    weaningData = userData.weaningData || {};
                    allergyData = userData.allergyData || {};
                    
                    if (userData.notes !== notes) {
                        notes = userData.notes || '';
                        document.getElementById('notesArea').value = notes;
                    }
                    
                    if (userData.customStages) {
                        weaningStages = { ...weaningStages, ...userData.customStages };
                        renderStages();
                    }
                    
                    achievements = userData.achievements || {};
                    updateSummary();
                    updateAllFoodDisplays();
                }
            });
        }

        // Save data to Firebase
        async function saveToFirebase(dataType, data) {
            if (!currentUser) return;

            try {
                const userRef = ref(database, `users/${currentUser}/${dataType}`);
                await set(userRef, data);
                
                if (dataType === 'weaningData') {
                    checkAchievements();
                }
                
                showAutoSave('‚úÖ Synced to cloud!');
            } catch (error) {
                console.error('Error saving to Firebase:', error);
                showAutoSave('‚ùå Sync failed');
            }
        }

        // Achievement System
        function checkAchievements() {
            Object.entries(achievementList).forEach(([key, achievement]) => {
                if (!achievements[key] && achievement.trigger(weaningData)) {
                    achievements[key] = {
                        unlocked: true,
                        date: new Date().toISOString()
                    };
                    
                    showAchievement(achievement);
                    saveToFirebase('achievements', achievements);
                }
            });
        }

        function showAchievement(achievement) {
            document.getElementById('achievementIcon').textContent = achievement.icon;
            document.getElementById('achievementTitle').textContent = achievement.title;
            document.getElementById('achievementDesc').textContent = achievement.desc;
            document.getElementById('achievementPopup').style.display = 'block';
        }

        window.closeAchievement = function() {
            document.getElementById('achievementPopup').style.display = 'none';
        }

        // Helper functions for achievements
        function getTotalTried(data) {
            return Object.values(data).filter(item => item.tried).length;
        }

        function getFiveStarCount(data) {
            return Object.values(data).filter(item => item.rating === 5).length;
        }

        function hasRepeatedFood(data, count) {
            return Object.values(data).some(item => item.attempts >= count);
        }

        // Allergy System with History and UK Date Format
        window.openAllergyModal = function(stageName, foodName) {
            allergyModalData = { stage: stageName, food: foodName };
            document.getElementById('allergyFoodName').textContent = foodName;
            
            // Check for existing allergy history
            const allergyKey = `${stageName}-${foodName}`;
            const historyDiv = document.getElementById('allergyHistory');
            const historyList = document.getElementById('allergyHistoryList');
            
            if (allergyData[allergyKey]) {
                // Convert existing single report to array format for backwards compatibility
                if (!Array.isArray(allergyData[allergyKey])) {
                    allergyData[allergyKey] = [allergyData[allergyKey]];
                }
                
                historyDiv.style.display = 'block';
                historyList.innerHTML = '';
                
                allergyData[allergyKey].forEach((reaction, index) => {
                    const date = new Date(reaction.date);
                    const ukDate = date.toLocaleDateString('en-GB', {
                        day: '2-digit',
                        month: '2-digit', 
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const historyItem = document.createElement('div');
                    historyItem.style.cssText = 'margin-bottom: 10px; padding: 8px; background: rgba(255,193,7,0.1); border-radius: 5px; font-size: 0.9rem;';
                    historyItem.innerHTML = `
                        <strong>üìÖ ${ukDate}</strong><br>
                        <strong>Symptoms:</strong> ${reaction.symptoms.join(', ')}<br>
                        ${reaction.notes ? `<strong>Notes:</strong> ${reaction.notes}` : ''}
                    `;
                    historyList.appendChild(historyItem);
                });
            } else {
                historyDiv.style.display = 'none';
            }
            
            document.getElementById('allergyModal').style.display = 'block';
        }

        window.closeAllergyModal = function() {
            document.getElementById('allergyModal').style.display = 'none';
            // Clear selections
            document.querySelectorAll('.symptom-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.getElementById('allergyNotes').value = '';
        }

        // Symptom selection
        document.addEventListener('click', function(e) {
            if (e.target.matches('.symptom-option')) {
                e.target.classList.toggle('selected');
            }
        });

        window.saveAllergyReport = function() {
            const selectedSymptoms = Array.from(document.querySelectorAll('.symptom-option.selected'))
                .map(opt => opt.dataset.symptom);
            const notes = document.getElementById('allergyNotes').value;
            
            if (selectedSymptoms.length === 0) {
                alert('Please select at least one symptom');
                return;
            }

            const allergyKey = `${allergyModalData.stage}-${allergyModalData.food}`;
            const newReaction = {
                symptoms: selectedSymptoms,
                notes: notes,
                date: new Date().toISOString()
            };

            // Initialize as array or add to existing array
            if (!allergyData[allergyKey]) {
                allergyData[allergyKey] = [newReaction];
            } else if (Array.isArray(allergyData[allergyKey])) {
                allergyData[allergyKey].push(newReaction);
            } else {
                // Convert old single format to array
                allergyData[allergyKey] = [allergyData[allergyKey], newReaction];
            }

            // Mark food item visually
            const foodId = `${allergyModalData.stage}-${allergyModalData.food}`.replace(/[^a-zA-Z0-9]/g, '');
            const foodElement = document.getElementById(`food-${foodId}`);
            if (foodElement) {
                foodElement.classList.add('allergy-flagged');
            }

            saveToFirebase('allergyData', allergyData);
            closeAllergyModal();
            showAutoSave('‚ö†Ô∏è Allergy reaction reported!');
        }

        // Tab switching functionality
        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'stages') {
                renderStages();
            }
        }

        // Setup add meal tab functionality
        function setupAddMealTab() {
            const stageOptions = document.querySelectorAll('.stage-option');
            const mealInput = document.getElementById('mealName');
            const addBtn = document.getElementById('addMealBtn');

            stageOptions.forEach(option => {
                option.addEventListener('click', function() {
                    stageOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedStage = this.getAttribute('data-stage');
                    updateAddButton();
                });
            });

            mealInput.addEventListener('input', updateAddButton);
            addBtn.addEventListener('click', addCustomMeal);
        }

        function updateAddButton() {
            const mealInput = document.getElementById('mealName');
            const addBtn = document.getElementById('addMealBtn');
            const isValid = selectedStage && mealInput.value.trim().length > 0;
            addBtn.disabled = !isValid;
        }

        async function addCustomMeal() {
            const mealInput = document.getElementById('mealName');
            const mealName = mealInput.value.trim();
            
            if (selectedStage && mealName) {
                weaningStages[selectedStage].push(mealName);
                
                const customStages = {};
                Object.keys(weaningStages).forEach(stage => {
                    if (weaningStages[stage].includes(mealName)) {
                        customStages[stage] = weaningStages[stage];
                    }
                });
                
                await saveToFirebase('customStages', customStages);
                
                mealInput.value = '';
                document.querySelectorAll('.stage-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                selectedStage = null;
                updateAddButton();
                
                showAutoSave(`Added "${mealName}" to ${selectedStage}`);
                
                if (document.getElementById('stages').classList.contains('active')) {
                    renderStages();
                }
            }
        }

        // Render all stages
        function renderStages() {
            const container = document.getElementById('stagesContainer');
            container.innerHTML = '';

            Object.entries(weaningStages).forEach(([stageName, foods]) => {
                const stageDiv = document.createElement('div');
                stageDiv.className = 'stage';
                
                const triedCount = foods.filter(food => getFoodData(stageName, food).tried).length;
                const progressText = `${triedCount}/${foods.length} tried`;

                stageDiv.innerHTML = `
                    <div class="stage-header" onclick="toggleStage('${stageName}')">
                        <h3>${stageName}</h3>
                        <div class="stage-progress">${progressText}</div>
                    </div>
                    <div class="stage-content" id="stage-${stageName.replace(/[^a-zA-Z0-9]/g, '')}">
                        ${foods.map(food => createFoodItemHTML(stageName, food)).join('')}
                    </div>
                `;

                container.appendChild(stageDiv);
            });
        }

        // Toggle stage visibility
        window.toggleStage = function(stageName) {
            const stageContent = document.getElementById(`stage-${stageName.replace(/[^a-zA-Z0-9]/g, '')}`);
            stageContent.style.display = stageContent.style.display === 'none' ? 'grid' : 'none';
        }

        // Create food item HTML
        function createFoodItemHTML(stageName, foodName) {
            const foodData = getFoodData(stageName, foodName);
            const allergyKey = `${stageName}-${foodName}`;
            const hasAllergy = allergyData[allergyKey];
            const foodId = `${stageName}-${foodName}`.replace(/[^a-zA-Z0-9]/g, '');

            return `
                <div class="food-item ${hasAllergy ? 'allergy-flagged' : ''}" id="food-${foodId}">
                    <div class="food-name">${foodName}</div>
                    ${hasAllergy ? '<div class="allergy-flag" title="Allergic reaction reported">‚ö†Ô∏è</div>' : ''}
                    <div class="food-controls">
                        <div class="tried-container">
                            <input type="checkbox" class="tried-checkbox" 
                                   data-stage="${stageName}" data-food="${foodName}"
                                   ${foodData.tried ? 'checked' : ''}>
                            <label>Tried it</label>
                        </div>
                        <div class="counter-container">
                            <button class="counter-btn" data-stage="${stageName}" data-food="${foodName}" data-action="decrease">-</button>
                            <span class="counter-display">${foodData.attempts || 0}</span>
                            <button class="counter-btn" data-stage="${stageName}" data-food="${foodName}" data-action="increase">+</button>
                            <label>attempts</label>
                        </div>
                        <div class="rating-container">
                            ${[1,2,3,4,5].map(rating => 
                                `<span class="star ${foodData.rating >= rating ? 'filled' : ''}" 
                                       data-stage="${stageName}" data-food="${foodName}" data-rating="${rating}">‚≠ê</span>`
                            ).join('')}
                        </div>
                        <button class="allergy-btn" onclick="openAllergyModal('${stageName}', '${foodName}')">
                            ‚ö†Ô∏è Report Reaction
                        </button>
                    </div>
                </div>
            `;
        }

        // Event delegation for food controls
        document.addEventListener('click', function(e) {
            if (e.target.matches('.tried-checkbox')) {
                const { stage, food } = e.target.dataset;
                updateFoodData(stage, food, 'tried', e.target.checked);
                updateSummary();
                saveToFirebase('weaningData', weaningData);
            }
            
            if (e.target.matches('.counter-btn')) {
                e.stopPropagation();
                const { stage, food, action } = e.target.dataset;
                const currentAttempts = getFoodData(stage, food).attempts || 0;
                const newAttempts = action === 'increase' 
                    ? currentAttempts + 1 
                    : Math.max(0, currentAttempts - 1);
                
                updateFoodData(stage, food, 'attempts', newAttempts);
                updateFoodItemDisplay(stage, food);
                updateSummary();
                saveToFirebase('weaningData', weaningData);
            }
            
            if (e.target.matches('.star')) {
                e.stopPropagation();
                const { stage, food, rating } = e.target.dataset;
                updateFoodData(stage, food, 'rating', parseInt(rating));
                updateFoodItemDisplay(stage, food);
                updateSummary();
                saveToFirebase('weaningData', weaningData);
            }
        });

        // Update specific food item display
        function updateFoodItemDisplay(stageName, foodName) {
            const foodData = getFoodData(stageName, foodName);
            const foodId = `${stageName}-${foodName}`.replace(/[^a-zA-Z0-9]/g, '');
            const foodElement = document.getElementById(`food-${foodId}`);
            
            if (foodElement) {
                const counterDisplay = foodElement.querySelector('.counter-display');
                if (counterDisplay) {
                    counterDisplay.textContent = foodData.attempts || 0;
                }
                
                const stars = foodElement.querySelectorAll('.star');
                stars.forEach((star, index) => {
                    const rating = index + 1;
                    if (foodData.rating >= rating) {
                        star.classList.add('filled');
                    } else {
                        star.classList.remove('filled');
                    }
                });
                
                const checkbox = foodElement.querySelector('.tried-checkbox');
                if (checkbox) {
                    checkbox.checked = foodData.tried || false;
                }
            }
        }

        // Update all food displays (for realtime sync)
        function updateAllFoodDisplays() {
            Object.entries(weaningStages).forEach(([stageName, foods]) => {
                foods.forEach(food => {
                    updateFoodItemDisplay(stageName, food);
                });
            });
        }

        // Get food data
        function getFoodData(stageName, foodName) {
            const key = `${stageName}-${foodName}`;
            return weaningData[key] || { tried: false, attempts: 0, rating: 0 };
        }

        // Update food data
        function updateFoodData(stageName, foodName, property, value) {
            const key = `${stageName}-${foodName}`;
            if (!weaningData[key]) {
                weaningData[key] = { tried: false, attempts: 0, rating: 0 };
            }
            weaningData[key][property] = value;
        }

        // Update summary statistics
        function updateSummary() {
            let totalFoods = 0;
            let triedFoods = 0;
            let totalAttempts = 0;
            let totalRatings = 0;
            let ratedFoods = 0;
            let fiveStarFoods = 0;

            Object.entries(weaningStages).forEach(([stageName, foods]) => {
                foods.forEach(food => {
                    totalFoods++;
                    const foodData = getFoodData(stageName, food);
                    
                    if (foodData.tried) triedFoods++;
                    totalAttempts += foodData.attempts || 0;
                    
                    if (foodData.rating > 0) {
                        totalRatings += foodData.rating;
                        ratedFoods++;
                        if (foodData.rating === 5) fiveStarFoods++;
                    }
                });
            });

            document.getElementById('totalTried').textContent = triedFoods;
            document.getElementById('totalAttempts').textContent = totalAttempts;
            document.getElementById('avgRating').textContent = ratedFoods > 0 ? (totalRatings / ratedFoods).toFixed(1) : '0';
            document.getElementById('favoriteFoods').textContent = fiveStarFoods;

            const progressPercent = totalFoods > 0 ? (triedFoods / totalFoods * 100) : 0;
            document.getElementById('progressBar').style.width = `${progressPercent}%`;
            document.getElementById('progressText').textContent = `${Math.round(progressPercent)}% Complete`;
        }

        // Notes functionality
        function setupNotesListener() {
            const notesArea = document.getElementById('notesArea');
            let timeout;
            
            notesArea.addEventListener('input', function() {
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    notes = this.value;
                    saveToFirebase('notes', notes);
                }, 1000);
            });
        }

        // Loading indicator
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // Auto-save indicator
        function showAutoSave(message = '‚úÖ Synced to cloud!') {
            const indicator = document.getElementById('autoSaveIndicator');
            indicator.textContent = message;
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        // Export functionality
        window.exportData = function() {
            const exportData = {
                user: currentUser,
                weaningData: weaningData,
                allergyData: allergyData,
                notes: notes,
                customStages: weaningStages,
                achievements: achievements,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `${currentUser}-weaning-data-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showAutoSave('üì• Data exported successfully!');
        }

        // Import functionality
        window.importData = function() {
            document.getElementById('importFile').click();
        }

        window.handleImport = function(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (importedData.weaningData) {
                            weaningData = importedData.weaningData;
                            saveToFirebase('weaningData', weaningData);
                        }
                        
                        if (importedData.allergyData) {
                            allergyData = importedData.allergyData;
                            saveToFirebase('allergyData', allergyData);
                        }
                        
                        if (importedData.notes) {
                            notes = importedData.notes;
                            document.getElementById('notesArea').value = notes;
                            saveToFirebase('notes', notes);
                        }
                        
                        if (importedData.customStages) {
                            weaningStages = importedData.customStages;
                            saveToFirebase('customStages', weaningStages);
                        }

                        if (importedData.achievements) {
                            achievements = importedData.achievements;
                            saveToFirebase('achievements', achievements);
                        }
                        
                        renderStages();
                        updateSummary();
                        showAutoSave('üì§ Data imported and synced!');
                        
                    } catch (error) {
                        alert('Error importing data. Please check the file format.');
                    }
                };
                reader.readAsText(file);
            }
        }

    </script>
</body>
</html>


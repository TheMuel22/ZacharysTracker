<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zachary's Weaning Tracker</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #ff9a9e, #fecfef); min-height: 100vh; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 30px; text-align: center; }
        .header-logo { max-width: 300px; max-height: 120px; width: auto; height: auto; margin-bottom: 15px; object-fit: contain; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .header p { font-size: 1.1rem; opacity: 0.9; }
        .tabs { display: flex; background: #f8f9fa; border-bottom: 2px solid #dee2e6; }
        .tab { flex: 1; padding: 15px; text-align: center; background: none; border: none; cursor: pointer; font-size: 1rem; font-weight: bold; color: #6c757d; transition: all 0.3s ease; }
        .tab.active { color: #667eea; background: white; border-bottom: 3px solid #667eea; }
        .tab:hover { background: #e9ecef; color: #495057; }
        .content { padding: 20px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .summary-card { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .summary-number { font-size: 2.5rem; font-weight: bold; margin-bottom: 10px; }
        .summary-label { font-size: 1rem; opacity: 0.9; }
        .progress-bar { background: #e9ecef; border-radius: 20px; height: 30px; overflow: hidden; margin: 20px 0; position: relative; }
        .progress-fill { background: linear-gradient(135deg, #28a745, #20c997); height: 100%; transition: width 0.5s ease; border-radius: 20px; }
        .progress-text { position: absolute; width: 100%; text-align: center; line-height: 30px; font-weight: bold; color: #495057; }
        .controls { display: flex; gap: 10px; justify-content: center; margin: 20px 0; flex-wrap: wrap; }
        .export-btn, .import-btn { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-weight: bold; transition: all 0.3s ease; }
        .export-btn:hover, .import-btn:hover { background: #0056b3; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,123,255,0.3); }
        .stage { margin-bottom: 25px; border-radius: 15px; background: white; box-shadow: 0 5px 15px rgba(0,0,0,0.1); overflow: hidden; }
        .stage-header { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; cursor: pointer; transition: all 0.3s ease; display: flex; justify-content: space-between; align-items: center; }
        .stage-header:hover { background: linear-gradient(135deg, #5a67d8, #6b46c1); }
        .stage-header h3 { font-size: 1.3rem; }
        .stage-progress { font-size: 0.9rem; opacity: 0.9; }
        .stage-content { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; padding: 25px; background: #f8f9fa; }
        .food-item { background: white; padding: 20px; border-radius: 12px; border: 2px solid #e9ecef; transition: all 0.3s ease; }
        .food-item:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .food-name { font-weight: bold; font-size: 1.1rem; margin-bottom: 15px; color: #495057; }
        .food-controls { display: flex; flex-direction: column; gap: 10px; }
        .tried-container { display: flex; align-items: center; gap: 10px; }
        .tried-checkbox { width: 20px; height: 20px; cursor: pointer; }
        .counter-container { display: flex; align-items: center; gap: 10px; }
        .counter-btn { background: #667eea; color: white; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; font-weight: bold; transition: all 0.3s ease; }
        .counter-btn:hover { background: #5a67d8; transform: scale(1.1); }
        .counter-display { font-size: 1.2rem; font-weight: bold; color: #495057; min-width: 30px; text-align: center; }
        .rating-container { display: flex; gap: 5px; align-items: center; }
        .star { font-size: 1.5rem; cursor: pointer; transition: all 0.3s ease; filter: grayscale(100%); }
        .star.filled { filter: none; }
        .star:hover { transform: scale(1.2); }
        .notes-section { background: white; padding: 20px; margin-top: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .notes-section h3 { color: #495057; margin-bottom: 15px; }
        .notes-textarea { width: 100%; height: 100px; border: 2px solid #e9ecef; border-radius: 10px; padding: 15px; font-family: inherit; resize: vertical; }
        .notes-textarea:focus { outline: none; border-color: #667eea; }
        .auto-save-indicator { position: fixed; bottom: 20px; right: 20px; background: #28a745; color: white; padding: 10px 15px; border-radius: 20px; font-size: 0.9rem; opacity: 0; transition: opacity 0.3s ease; }
        .auto-save-indicator.show { opacity: 1; }
        .add-meal-section { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin: 20px 0; }
        .add-meal-section h3 { color: #495057; margin-bottom: 25px; font-size: 1.5rem; text-align: center; }
        .stage-selector { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stage-option { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 2px solid #dee2e6; border-radius: 12px; padding: 15px; text-align: center; font-weight: 600; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden; }
        .stage-option:hover { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 182, 193, 0.4); }
        .stage-option.selected { background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%); color: white; transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 107, 107, 0.5); border: 2px solid #ff4757; }
        .meal-input-section { display: flex; gap: 15px; align-items: center; margin-bottom: 20px; }
        .meal-input { flex: 1; padding: 12px 20px; border: 2px solid #dee2e6; border-radius: 25px; font-size: 1rem; transition: all 0.3s ease; background: white; }
        .meal-input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .add-meal-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 25px; border-radius: 25px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; white-space: nowrap; }
        .add-meal-btn:hover:not(:disabled) { background: linear-gradient(135deg, #5a6fd8 0%, #6a4c93 100%); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3); }
        .add-meal-btn:disabled { background: #6c757d; cursor: not-allowed; opacity: 0.6; }
        .loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255,255,255,0.9); padding: 20px; border-radius: 10px; z-index: 1000; }
        @media (max-width: 768px) { .header h1 { font-size: 1.8rem; } .header-logo { max-width: 250px; max-height: 100px; } .summary-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); } .stage-content { grid-template-columns: 1fr; } .controls { flex-direction: column; align-items: center; } .stage-selector { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; } .stage-option { padding: 10px; font-size: 0.9rem; } .meal-input-section { flex-direction: column; align-items: stretch; } .add-meal-btn { width: 100%; margin-top: 10px; } }
    </style>
</head>
<body>
    <div id="loading" class="loading" style="display: none;">
        <div>üîÑ Syncing data...</div>
    </div>

    <div class="container">
        <div class="header">
            <img src="this.png" alt="Zachary's Weaning Tracker" class="header-logo">
            <p>Track every taste, every try, every triumph! (Synced across all devices)</p>
        </div>
        <div class="tabs">
            <button class="tab active" onclick="switchTab('summary')">üìä Summary</button>
            <button class="tab" onclick="switchTab('stages')">üìÖ Stages</button>
            <button class="tab" onclick="switchTab('addMeal')">‚ûï Add Meal</button>
        </div>
        <div class="content">
            <div id="summary" class="tab-content active">
                <div class="summary-grid">
                    <div class="summary-card"><div class="summary-number" id="totalTried">0</div><div class="summary-label">Foods Tried</div></div>
                    <div class="summary-card"><div class="summary-number" id="totalAttempts">0</div><div class="summary-label">Total Attempts</div></div>
                    <div class="summary-card"><div class="summary-number" id="avgRating">0</div><div class="summary-label">Average Rating</div></div>
                    <div class="summary-card"><div class="summary-number" id="favoriteFoods">0</div><div class="summary-label">5-Star Foods</div></div>
                </div>
                <div class="progress-bar"><div class="progress-fill" id="progressBar"></div><div class="progress-text" id="progressText">0% Complete</div></div>
                <div class="controls">
                    <button class="export-btn" onclick="exportData()">üì• Export Data</button>
                    <button class="import-btn" onclick="importData()">üì§ Import Data</button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImport(this)">
                </div>
                <div class="notes-section"><h3>üìù Notes</h3><textarea class="notes-textarea" id="notesArea" placeholder="Add any notes about Zachary's weaning journey..."></textarea></div>
            </div>
            <div id="stages" class="tab-content"><div id="stagesContainer"></div></div>
            <div id="addMeal" class="tab-content">
                <div class="add-meal-section">
                    <h3>Add Custom Meal</h3>
                    <p style="text-align: center; margin-bottom: 25px; color: #6c757d;">Add a custom food for Zachary and choose which weaning stage it belongs to.</p>
                    <div class="stage-selector">
                        <div class="stage-option" data-stage="Week 1-2: First Tastes"><strong>Week 1-2</strong><br>First Tastes</div>
                        <div class="stage-option" data-stage="Week 3-4: Building Confidence"><strong>Week 3-4</strong><br>Building Confidence</div>
                        <div class="stage-option" data-stage="Week 5-6: Introducing Lumps"><strong>Week 5-6</strong><br>Introducing Lumps</div>
                        <div class="stage-option" data-stage="Week 7-10: Variety & Textures"><strong>Week 7-10</strong><br>Variety & Textures</div>
                        <div class="stage-option" data-stage="Week 11-16: Chopped & Chunkier"><strong>Week 11-16</strong><br>Chopped & Chunkier</div>
                        <div class="stage-option" data-stage="Month 9-12: Joining Family Meals"><strong>Month 9-12</strong><br>Joining Family Meals</div>
                    </div>
                    <div class="meal-input-section">
                        <input type="text" id="mealName" class="meal-input" placeholder="Enter custom meal name (e.g., 'Homemade applesauce')" maxlength="50">
                        <button id="addMealBtn" class="add-meal-btn" disabled>Add Meal</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="auto-save-indicator" id="autoSaveIndicator">‚úÖ Synced to cloud!</div>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
        import { getDatabase, ref, onValue, set, push, get } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js';

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCFGP2fcznEA_ubCtcWpQT4Ny99R7U4vHY",
            authDomain: "zachary-weaning.firebaseapp.com",
            databaseURL: "https://zachary-weaning-default-rtdb.firebaseio.com",
            projectId: "zachary-weaning",
            storageBucket: "zachary-weaning.firebasestorage.app",
            messagingSenderId: "135558156277",
            appId: "1:135558156277:web:97055f024492f3a7879abc",
            measurementId: "G-3WWJ4G6XEC"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Weaning stages data (mutable for custom meals)
        let weaningStages = {
            "Week 1-2: First Tastes": ["Apple puree", "Banana", "Carrot puree", "Sweet potato", "Pear puree", "Broccoli puree", "Butternut squash", "Avocado", "Baby rice", "Parsnip puree"],
            "Week 3-4: Building Confidence": ["Cauliflower puree", "Courgette puree", "Mango puree", "Peach puree", "Green beans puree", "Pumpkin puree", "Spinach puree", "Potato puree", "Papaya puree", "Beetroot puree"],
            "Week 5-6: Introducing Lumps": ["Mashed banana", "Well-cooked pasta shapes", "Soft cooked apple pieces", "Mashed sweet potato with lumps", "Soft steamed broccoli florets", "Mashed avocado with texture", "Soft cooked carrot sticks", "Rice with soft vegetables", "Mashed potato with lumps", "Soft cooked pear pieces"],
            "Week 7-10: Variety & Textures": ["Scrambled egg", "Soft cooked chicken strips", "Toast fingers", "Cheese cubes", "Soft cooked fish flakes", "Pasta with sauce", "Steamed vegetable sticks", "Soft fruits in pieces", "Rice cakes", "Yogurt", "Well-cooked lentils", "Soft cooked beef strips"],
            "Week 11-16: Chopped & Chunkier": ["Chopped chicken", "Chopped vegetables", "Harder fruits", "Sandwich pieces", "Mini meatballs", "Chopped hard-boiled egg", "Pasta salad", "Roasted vegetables", "Grated cheese", "Chopped fish", "Bean salads", "Finger foods"],
            "Month 9-12: Joining Family Meals": ["Family meal portions", "Whole fruits", "Raw vegetables", "Nuts (chopped/ground)", "Whole grains", "Spiced foods", "Mixed textures", "Self-feeding foods", "Cup drinking", "Family snacks", "Complex meals", "Adult portions (smaller)"]
        };

        // Data storage
        let weaningData = {};
        let notes = '';
        let selectedStage = null;

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            loadFromFirebase();
            setupAddMealTab();
            setupRealtimeListeners();
        });

        // Load data from Firebase
        async function loadFromFirebase() {
            showLoading(true);
            try {
                // Load weaning data
                const dataRef = ref(database, 'weaningData');
                const dataSnapshot = await get(dataRef);
                if (dataSnapshot.exists()) {
                    weaningData = dataSnapshot.val();
                }

                // Load notes
                const notesRef = ref(database, 'notes');
                const notesSnapshot = await get(notesRef);
                if (notesSnapshot.exists()) {
                    notes = notesSnapshot.val();
                    document.getElementById('notesArea').value = notes;
                }

                // Load custom stages
                const stagesRef = ref(database, 'customStages');
                const stagesSnapshot = await get(stagesRef);
                if (stagesSnapshot.exists()) {
                    weaningStages = { ...weaningStages, ...stagesSnapshot.val() };
                }

                renderStages();
                updateSummary();
                setupNotesListener();
                showLoading(false);
            } catch (error) {
                console.error('Error loading from Firebase:', error);
                showLoading(false);
                showAutoSave('‚ùå Connection error - using local data');
            }
        }

        // Setup realtime listeners for changes
        function setupRealtimeListeners() {
            // Listen for data changes
            const dataRef = ref(database, 'weaningData');
            onValue(dataRef, (snapshot) => {
                if (snapshot.exists()) {
                    weaningData = snapshot.val();
                    updateSummary();
                    updateAllFoodDisplays();
                }
            });

            // Listen for notes changes
            const notesRef = ref(database, 'notes');
            onValue(notesRef, (snapshot) => {
                if (snapshot.exists()) {
                    const newNotes = snapshot.val();
                    if (newNotes !== notes) {
                        notes = newNotes;
                        document.getElementById('notesArea').value = notes;
                    }
                }
            });

            // Listen for custom stages changes
            const stagesRef = ref(database, 'customStages');
            onValue(stagesRef, (snapshot) => {
                if (snapshot.exists()) {
                    const customStages = snapshot.val();
                    weaningStages = { ...weaningStages, ...customStages };
                    renderStages();
                    updateSummary();
                }
            });
        }

        // Save data to Firebase
        async function saveToFirebase(path, data) {
            try {
                await set(ref(database, path), data);
                showAutoSave('‚úÖ Synced to cloud!');
            } catch (error) {
                console.error('Error saving to Firebase:', error);
                showAutoSave('‚ùå Sync failed');
            }
        }

        // Tab switching functionality
        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'stages') {
                renderStages();
            }
        }

        // Setup add meal tab functionality
        function setupAddMealTab() {
            const stageOptions = document.querySelectorAll('.stage-option');
            const mealInput = document.getElementById('mealName');
            const addBtn = document.getElementById('addMealBtn');

            stageOptions.forEach(option => {
                option.addEventListener('click', function() {
                    stageOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedStage = this.getAttribute('data-stage');
                    updateAddButton();
                });
            });

            mealInput.addEventListener('input', updateAddButton);
            addBtn.addEventListener('click', addCustomMeal);
        }

        function updateAddButton() {
            const mealInput = document.getElementById('mealName');
            const addBtn = document.getElementById('addMealBtn');
            const isValid = selectedStage && mealInput.value.trim().length > 0;
            addBtn.disabled = !isValid;
        }

        async function addCustomMeal() {
            const mealInput = document.getElementById('mealName');
            const mealName = mealInput.value.trim();
            
            if (selectedStage && mealName) {
                weaningStages[selectedStage].push(mealName);
                
                // Save custom stages to Firebase
                const customStages = {};
                Object.keys(weaningStages).forEach(stage => {
                    if (weaningStages[stage].includes(mealName)) {
                        customStages[stage] = weaningStages[stage];
                    }
                });
                
                await saveToFirebase('customStages', customStages);
                
                mealInput.value = '';
                document.querySelectorAll('.stage-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                selectedStage = null;
                updateAddButton();
                
                showAutoSave(`Added "${mealName}" to ${selectedStage}`);
                
                if (document.getElementById('stages').classList.contains('active')) {
                    renderStages();
                }
            }
        }

        // Render all stages
        function renderStages() {
            const container = document.getElementById('stagesContainer');
            container.innerHTML = '';

            Object.entries(weaningStages).forEach(([stageName, foods]) => {
                const stageDiv = document.createElement('div');
                stageDiv.className = 'stage';
                
                const triedCount = foods.filter(food => getFoodData(stageName, food).tried).length;
                const progressText = `${triedCount}/${foods.length} tried`;

                stageDiv.innerHTML = `
                    <div class="stage-header" onclick="toggleStage('${stageName}')">
                        <h3>${stageName}</h3>
                        <div class="stage-progress">${progressText}</div>
                    </div>
                    <div class="stage-content" id="stage-${stageName.replace(/[^a-zA-Z0-9]/g, '')}">
                        ${foods.map(food => createFoodItemHTML(stageName, food)).join('')}
                    </div>
                `;

                container.appendChild(stageDiv);
            });
        }

        // Toggle stage visibility
        window.toggleStage = function(stageName) {
            const stageContent = document.getElementById(`stage-${stageName.replace(/[^a-zA-Z0-9]/g, '')}`);
            stageContent.style.display = stageContent.style.display === 'none' ? 'grid' : 'none';
        }

        // Create food item HTML
        function createFoodItemHTML(stageName, foodName) {
            const foodData = getFoodData(stageName, foodName);
            const foodId = `${stageName}-${foodName}`.replace(/[^a-zA-Z0-9]/g, '');

            return `
                <div class="food-item" id="food-${foodId}">
                    <div class="food-name">${foodName}</div>
                    <div class="food-controls">
                        <div class="tried-container">
                            <input type="checkbox" class="tried-checkbox" 
                                   data-stage="${stageName}" data-food="${foodName}"
                                   ${foodData.tried ? 'checked' : ''}>
                            <label>Tried it</label>
                        </div>
                        <div class="counter-container">
                            <button class="counter-btn" data-stage="${stageName}" data-food="${foodName}" data-action="decrease">-</button>
                            <span class="counter-display">${foodData.attempts || 0}</span>
                            <button class="counter-btn" data-stage="${stageName}" data-food="${foodName}" data-action="increase">+</button>
                            <label>attempts</label>
                        </div>
                        <div class="rating-container">
                            ${[1,2,3,4,5].map(rating => 
                                `<span class="star ${foodData.rating >= rating ? 'filled' : ''}" 
                                       data-stage="${stageName}" data-food="${foodName}" data-rating="${rating}">‚≠ê</span>`
                            ).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // Event delegation for food controls
        document.addEventListener('click', function(e) {
            if (e.target.matches('.tried-checkbox')) {
                const { stage, food } = e.target.dataset;
                updateFoodData(stage, food, 'tried', e.target.checked);
                updateSummary();
                saveToFirebase('weaningData', weaningData);
            }
            
            if (e.target.matches('.counter-btn')) {
                e.stopPropagation();
                const { stage, food, action } = e.target.dataset;
                const currentAttempts = getFoodData(stage, food).attempts || 0;
                const newAttempts = action === 'increase' 
                    ? currentAttempts + 1 
                    : Math.max(0, currentAttempts - 1);
                
                updateFoodData(stage, food, 'attempts', newAttempts);
                updateFoodItemDisplay(stage, food);
                updateSummary();
                saveToFirebase('weaningData', weaningData);
            }
            
            if (e.target.matches('.star')) {
                e.stopPropagation();
                const { stage, food, rating } = e.target.dataset;
                updateFoodData(stage, food, 'rating', parseInt(rating));
                updateFoodItemDisplay(stage, food);
                updateSummary();
                saveToFirebase('weaningData', weaningData);
            }
        });

        // Update specific food item display
        function updateFoodItemDisplay(stageName, foodName) {
            const foodData = getFoodData(stageName, foodName);
            const foodId = `${stageName}-${foodName}`.replace(/[^a-zA-Z0-9]/g, '');
            const foodElement = document.getElementById(`food-${foodId}`);
            
            if (foodElement) {
                const counterDisplay = foodElement.querySelector('.counter-display');
                if (counterDisplay) {
                    counterDisplay.textContent = foodData.attempts || 0;
                }
                
                const stars = foodElement.querySelectorAll('.star');
                stars.forEach((star, index) => {
                    const rating = index + 1;
                    if (foodData.rating >= rating) {
                        star.classList.add('filled');
                    } else {
                        star.classList.remove('filled');
                    }
                });
                
                const checkbox = foodElement.querySelector('.tried-checkbox');
                if (checkbox) {
                    checkbox.checked = foodData.tried || false;
                }
            }
        }

        // Update all food displays (for realtime sync)
        function updateAllFoodDisplays() {
            Object.entries(weaningStages).forEach(([stageName, foods]) => {
                foods.forEach(food => {
                    updateFoodItemDisplay(stageName, food);
                });
            });
        }

        // Get food data
        function getFoodData(stageName, foodName) {
            const key = `${stageName}-${foodName}`;
            return weaningData[key] || { tried: false, attempts: 0, rating: 0 };
        }

        // Update food data
        function updateFoodData(stageName, foodName, property, value) {
            const key = `${stageName}-${foodName}`;
            if (!weaningData[key]) {
                weaningData[key] = { tried: false, attempts: 0, rating: 0 };
            }
            weaningData[key][property] = value;
        }

        // Update summary statistics
        function updateSummary() {
            let totalFoods = 0;
            let triedFoods = 0;
            let totalAttempts = 0;
            let totalRatings = 0;
            let ratedFoods = 0;
            let fiveStarFoods = 0;

            Object.entries(weaningStages).forEach(([stageName, foods]) => {
                foods.forEach(food => {
                    totalFoods++;
                    const foodData = getFoodData(stageName, food);
                    
                    if (foodData.tried) triedFoods++;
                    totalAttempts += foodData.attempts || 0;
                    
                    if (foodData.rating > 0) {
                        totalRatings += foodData.rating;
                        ratedFoods++;
                        if (foodData.rating === 5) fiveStarFoods++;
                    }
                });
            });

            document.getElementById('totalTried').textContent = triedFoods;
            document.getElementById('totalAttempts').textContent = totalAttempts;
            document.getElementById('avgRating').textContent = ratedFoods > 0 ? (totalRatings / ratedFoods).toFixed(1) : '0';
            document.getElementById('favoriteFoods').textContent = fiveStarFoods;

            const progressPercent = totalFoods > 0 ? (triedFoods / totalFoods * 100) : 0;
            document.getElementById('progressBar').style.width = `${progressPercent}%`;
            document.getElementById('progressText').textContent = `${Math.round(progressPercent)}% Complete`;
        }

        // Notes functionality
        function setupNotesListener() {
            const notesArea = document.getElementById('notesArea');
            let timeout;
            
            notesArea.addEventListener('input', function() {
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    notes = this.value;
                    saveToFirebase('notes', notes);
                }, 1000); // Debounce saves
            });
        }

        // Loading indicator
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // Auto-save indicator
        function showAutoSave(message = '‚úÖ Synced to cloud!') {
            const indicator = document.getElementById('autoSaveIndicator');
            indicator.textContent = message;
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        // Export functionality
        window.exportData = function() {
            const exportData = {
                weaningData: weaningData,
                notes: notes,
                customStages: weaningStages,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `zachary-weaning-data-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showAutoSave('üì• Data exported successfully!');
        }

        // Import functionality
        window.importData = function() {
            document.getElementById('importFile').click();
        }

        window.handleImport = function(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (importedData.weaningData) {
                            weaningData = importedData.weaningData;
                            saveToFirebase('weaningData', weaningData);
                        }
                        
                        if (importedData.notes) {
                            notes = importedData.notes;
                            document.getElementById('notesArea').value = notes;
                            saveToFirebase('notes', notes);
                        }
                        
                        if (importedData.customStages) {
                            weaningStages = importedData.customStages;
                            saveToFirebase('customStages', weaningStages);
                        }
                        
                        renderStages();
                        updateSummary();
                        showAutoSave('üì§ Data imported and synced!');
                        
                    } catch (error) {
                        alert('Error importing data. Please check the file format.');
                    }
                };
                reader.readAsText(file);
            }
        }

    </script>
</body>
</html>

   <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-adsense-account" content="ca-pub-2925048158561041">
    <title>Zachary's Weaning Tracker</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #ff9a9e, #fecfef); min-height: 100vh; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 30px; text-align: center; }
        .header-logo { max-width: 600px; max-height: 240px; width: auto; height: auto; margin-bottom: 15px; object-fit: contain; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .header p { font-size: 1.1rem; opacity: 0.9; }
        .user-info { position: absolute; top: 15px; right: 15px; color: white; font-size: 0.9rem; }
        .logout-btn { background: rgba(255,255,255,0.2); color: white; border: none; padding: 5px 10px; border-radius: 15px; cursor: pointer; margin-left: 10px; }
        .logout-btn:hover { background: rgba(255,255,255,0.3); }
        .tabs { display: flex; background: #f8f9fa; border-bottom: 2px solid #dee2e6; }
        .tab { flex: 1; padding: 15px; text-align: center; background: none; border: none; cursor: pointer; font-size: 1rem; font-weight: bold; color: #6c757d; transition: all 0.3s ease; }
        .tab.active { color: #667eea; background: white; border-bottom: 3px solid #667eea; }
        .tab:hover { background: #e9ecef; color: #495057; }
        .content { padding: 20px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .summary-card { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .summary-number { font-size: 2.5rem; font-weight: bold; margin-bottom: 10px; }
        .summary-label { font-size: 1rem; opacity: 0.9; }
        .progress-bar { background: #e9ecef; border-radius: 20px; height: 30px; overflow: hidden; margin: 20px 0; position: relative; }
        .progress-fill { background: linear-gradient(135deg, #28a745, #20c997); height: 100%; transition: width 0.5s ease; border-radius: 20px; }
        .progress-text { position: absolute; width: 100%; text-align: center; line-height: 30px; font-weight: bold; color: #495057; }
        .controls { display: flex; gap: 10px; justify-content: center; margin: 20px 0; flex-wrap: wrap; }
        .export-btn, .import-btn { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-weight: bold; transition: all 0.3s ease; }
        .export-btn:hover, .import-btn:hover { background: #0056b3; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,123,255,0.3); }
        .stage { margin-bottom: 25px; border-radius: 15px; background: white; box-shadow: 0 5px 15px rgba(0,0,0,0.1); overflow: hidden; }
        .stage-header { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; cursor: pointer; transition: all 0.3s ease; display: flex; justify-content: space-between; align-items: center; }
        .stage-header:hover { background: linear-gradient(135deg, #5a67d8, #6b46c1); }
        .stage-header h3 { font-size: 1.3rem; }
        .stage-progress { font-size: 0.9rem; opacity: 0.9; }
    .stage-info { background: transparent; border: none; padding: 6px; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; }
    .stage-info:focus { outline: none; box-shadow: none; }
    /* collapsed by default; .stage.open will show the content */
    .stage-content { display: none; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; padding: 25px; background: #f8f9fa; }
    .stage.open .stage-content { display: grid; }
        .food-item { background: white; padding: 20px; border-radius: 12px; border: 2px solid #e9ecef; transition: all 0.3s ease; position: relative; }
        .food-item:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .food-item.allergy-flagged { border-color: #ffc107; background: #fffbf0; }
        .food-name { font-weight: bold; font-size: 1.1rem; margin-bottom: 15px; color: #495057; }
        .allergy-flag { position: absolute; top: 10px; right: 10px; background: #ffc107; color: #212529; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; cursor: pointer; }
        .food-controls { display: flex; flex-direction: column; gap: 10px; }
        .tried-container { display: flex; align-items: center; gap: 10px; }
        .tried-checkbox { width: 20px; height: 20px; cursor: pointer; }
        .counter-container { display: flex; align-items: center; gap: 10px; }
        .counter-btn { background: #667eea; color: white; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; font-weight: bold; transition: all 0.3s ease; }
        .counter-btn:hover { background: #5a67d8; transform: scale(1.1); }
        .counter-display { font-size: 1.2rem; font-weight: bold; color: #495057; min-width: 30px; text-align: center; }
        .rating-container { display: flex; gap: 5px; align-items: center; }
        .star { font-size: 1.5rem; cursor: pointer; transition: all 0.3s ease; filter: grayscale(100%); }
        .star.filled { filter: none; }
        .star:hover { transform: scale(1.2); }
        .allergy-btn { background: #ffc107; color: #212529; border: none; padding: 8px 12px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; margin-top: 10px; }
        .allergy-btn:hover { background: #e0a800; }
        .notes-section { background: white; padding: 20px; margin-top: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .notes-section h3 { color: #495057; margin-bottom: 15px; }
        .notes-textarea { width: 100%; height: 100px; border: 2px solid #e9ecef; border-radius: 10px; padding: 15px; font-family: inherit; resize: vertical; }
        .notes-textarea:focus { outline: none; border-color: #667eea; }
        .auto-save-indicator { position: fixed; bottom: 20px; right: 20px; background: #28a745; color: white; padding: 10px 15px; border-radius: 20px; font-size: 0.9rem; opacity: 0; transition: opacity 0.3s ease; }
        .auto-save-indicator.show { opacity: 1; }
        .add-meal-section { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin: 20px 0; }
        .add-meal-section h3 { color: #495057; margin-bottom: 25px; font-size: 1.5rem; text-align: center; }
        .stage-selector { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stage-option { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 2px solid #dee2e6; border-radius: 12px; padding: 15px; text-align: center; font-weight: 600; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden; }
        .stage-option:hover { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 182, 193, 0.4); }
        .stage-option.selected { background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%); color: white; transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 107, 107, 0.5); border: 2px solid #ff4757; }
        .meal-input-section { display: flex; gap: 15px; align-items: center; margin-bottom: 20px; }
        .meal-input { flex: 1; padding: 12px 20px; border: 2px solid #dee2e6; border-radius: 25px; font-size: 1rem; transition: all 0.3s ease; background: white; }
        .meal-input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .add-meal-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 25px; border-radius: 25px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; white-space: nowrap; }
        .add-meal-btn:hover:not(:disabled) { background: linear-gradient(135deg, #5a6fd8 0%, #6a4c93 100%); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3); }
        .add-meal-btn:disabled { background: #6c757d; cursor: not-allowed; opacity: 0.6; }
        .loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255,255,255,0.9); padding: 20px; border-radius: 10px; z-index: 1000; }

        /* Login Screen */
        .login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #ff9a9e, #fecfef); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .login-container { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); max-width: 400px; width: 90%; }
        .login-title { text-align: center; margin-bottom: 30px; color: #495057; }
        .login-form { display: flex; flex-direction: column; gap: 15px; }
        .login-input { padding: 15px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 1rem; }
        .login-input:focus { outline: none; border-color: #667eea; }
        .login-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 15px; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; }
        .login-btn:hover { background: linear-gradient(135deg, #5a6fd8 0%, #6a4c93 100%); }
        .register-toggle { text-align: center; margin-top: 15px; color: #6c757d; cursor: pointer; }
        .register-toggle:hover { color: #495057; }

    /* Login Screen (overview) */
    .login-overview { text-align: center; margin: 12px 0 18px; color: #495057; }
    .overview-images { display: flex; gap: 10px; justify-content: center; margin-bottom: 10px; }
    .overview-images img { width: 76px; height: 76px; object-fit: contain; border-radius: 12px; border: 1px solid #e9ecef; padding: 6px; background: white; }
    .overview-bullets { text-align: left; margin: 0 auto 12px; max-width: 360px; font-size: 0.95rem; color: #6c757d; }
    .overview-bullets ul { padding-left: 18px; }
    .overview-bullets li { margin-bottom: 6px; }
    .try-demo-btn { background: #28a745; color: white; padding: 8px 12px; border-radius: 20px; border: none; cursor: pointer; font-weight: 700; margin-top: 8px; }
    .try-demo-btn:hover { background: #20c997; }
    .about-btn { background: #28a745; color: white; padding: 8px 12px; border-radius: 20px; border: none; cursor: pointer; font-weight: 700; }
    .about-btn:hover { background: #20c997; }
    .demo-back-btn { background: #6c757d; color: white; padding: 8px 12px; border-radius: 20px; border: none; cursor: pointer; font-weight: 700; margin-left: 8px; }
    .demo-back-btn:hover { background: #5a6268; }

        /* Achievement Popup */
        .achievement-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 20px; box-shadow: 0 15px 40px rgba(0,0,0,0.3); z-index: 3000; text-align: center; max-width: 400px; width: 90%; }
        .achievement-icon { font-size: 4rem; margin-bottom: 15px; }
        .achievement-title { font-size: 1.5rem; font-weight: bold; color: #495057; margin-bottom: 10px; }
        .achievement-desc { color: #6c757d; margin-bottom: 20px; }
        .achievement-close { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; }

        /* Allergy Modal */
        .allergy-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 3000; }
        .allergy-modal-content { background: white; padding: 30px; border-radius: 20px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .allergy-symptoms { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 20px 0; }
        .symptom-option { background: #f8f9fa; border: 2px solid #dee2e6; padding: 10px; border-radius: 10px; cursor: pointer; text-align: center; transition: all 0.3s ease; }
        .symptom-option.selected { background: #fffbf0; border-color: #ffc107; color: #856404; }
        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .modal-btn { padding: 10px 20px; border: none; border-radius: 25px; cursor: pointer; font-weight: 600; }
        .modal-btn.save { background: #ffc107; color: #212529; }
        .modal-btn.cancel { background: #6c757d; color: white; }

        @media (max-width: 768px) { 
            .header { padding: 20px 15px; text-align: center; }
            .header h1 { font-size: 1.8rem; } 
            .header-logo { width: calc(100% - 30px); max-width: calc(100vw - 70px); height: auto; max-height: 20vh; object-fit: contain; display: block; margin: 0 auto 15px auto; } 
            .user-info { position: static; margin-bottom: 15px; }
            .summary-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); } 
            .stage-content { grid-template-columns: 1fr; } 
            .controls { flex-direction: column; align-items: center; } 
            .stage-selector { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; } 
            .stage-option { padding: 10px; font-size: 0.9rem; } 
            .meal-input-section { flex-direction: column; align-items: stretch; } 
            .add-meal-btn { width: 100%; margin-top: 10px; } 
        }

        

        /* Info modal title separator */
        .info-modal h4 { border-bottom: 1px solid #e9ecef; padding-bottom: 8px; margin-bottom: 10px; }
    /* Monetization UI - responsive */
    .monetize-row { display:flex; gap:12px; align-items:center; justify-content:center; margin:18px 0; flex-wrap:wrap; }
    /* allow children to shrink without overflowing their container */
    .monetize-row > * { min-width:0; }
    .monetize-row a { display:flex; align-items:center; justify-content:center; flex: 0 1 auto; text-decoration:none; color:inherit; }
    .buyme-link { display:flex; align-items:center; gap:8px; padding:6px 10px; background:#ffffff; border:1px solid #eee; border-radius:10px; box-shadow: 0 4px 10px rgba(0,0,0,0.04); font-weight:700; }
    .buyme-label { font-size:0.95rem; color:#333; }
    /* Ad placeholder removed per user request */
    .affiliate-card { background: linear-gradient(180deg,#fff 0%, #f8f9fa 100%); border: 1px solid #e9ecef; padding: 12px; border-radius: 12px; display:flex; gap:12px; align-items:center; justify-content:space-between; max-width:720px; margin: 12px auto; flex: 1 1 420px; }
    .affiliate-info { display:flex; gap:12px; align-items:center; }
    .affiliate-btn { background:#ff9900; color:#111; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700; text-decoration:none; }
    .affiliate-disclaimer { font-size:0.85rem; color:#6c757d; text-align:center; margin-top:8px; }

    /* Small screens: stack items vertically and make them full-width */
    @media (max-width: 480px) {
        .monetize-row { gap:10px; justify-content:center; }
        .monetize-row a, .monetize-row .ad-placeholder, .monetize-row .affiliate-card { flex: 1 1 100%; max-width:100%; margin-left:0; }
        .monetize-row a { padding:6px 0; }
        .buyme-link { justify-content:center; padding:10px; }
        .affiliate-card { padding:10px; gap:10px; }
        .affiliate-card img { width:56px; height:56px; }
        .monetize-row img { height:32px; }
        .affiliate-disclaimer { padding: 0 12px; text-align:center; }
    }
    /* Ella's Kitchen pouches UI */
    .ella-pouches-section { margin: 18px 0 6px 0; }
    .ella-pouches-section h4 { margin-bottom: 8px; color:#495057; }
    .pouches-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap:10px; margin-bottom: 12px; }
    .pouch-item { background: linear-gradient(180deg,#fff 0%, #f8f9fa 100%); border: 1px solid #e9ecef; padding:10px; border-radius:10px; display:flex; flex-direction:column; align-items:center; gap:8px; }
    .pouch-name { font-weight:700; text-align:center; font-size:0.95rem; color:#333; }
    .pouch-add-btn { background: linear-gradient(135deg,#667eea 0%, #764ba2 100%); color:white; border:none; padding:6px 10px; border-radius:8px; cursor:pointer; font-weight:600; }
    .pouch-add-btn:disabled { background:#6c757d; opacity:0.6; cursor:not-allowed; }
    /* consent and privacy UI removed per user request */
    /* Feedback UI */
    .feedback-btn { position: fixed; right: 18px; bottom: 22px; background: #ff6b6b; color: white; border: none; padding: 12px 14px; border-radius: 999px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); cursor: pointer; font-weight:700; z-index: 5000; }
    .feedback-btn:hover { transform: translateY(-2px); }
    .feedback-modal { position: fixed; left: 50%; top: 50%; transform: translate(-50%,-50%); background: white; padding: 18px; border-radius: 12px; box-shadow: 0 12px 40px rgba(0,0,0,0.25); z-index: 6000; max-width: 420px; width: 92%; display: none; }
    .feedback-modal h3 { margin-bottom: 8px; color: #495057; }
    .feedback-modal textarea, .feedback-modal input { width: 100%; border: 2px solid #e9ecef; border-radius: 8px; padding: 10px; font-family: inherit; }
    .feedback-modal .feedback-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:10px; }
    .feedback-modal .btn-submit { background: linear-gradient(135deg,#28a745,#20c997); color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:700; }
    .feedback-modal .btn-cancel { background:#6c757d; color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
            <div class="login-container">
                <img src="this.png" alt="Weaning Tracker Logo" style="display:block; margin:0 auto 12px auto; max-width:220px;" />

                <!-- New overview for the login screen -->
                <div class="login-overview" aria-hidden="false">
                    <!-- About button removed as requested -->
                    <div style="margin-bottom:10px;">
                        <!-- intentionally left blank after removing about button -->
                    </div>

                    <div id="overviewContent" style="display:none;">
                        <div class="overview-images" aria-hidden="true">
                            <img src="stages.png" alt="Stages">
                            <img src="addmeal.png" alt="Add meal">
                            <img src="summary.png" alt="Summary">
                        </div>

                        <div class="overview-bullets">
                            <ul>
                                <li><strong>Quick logging:</strong> Tap tried / + / rating to capture every meal in seconds.</li>
                                <li><strong>Stage-based tips:</strong> Guided foods and allergy tracking for each weaning stage.</li>
                                <li><strong>Cloud sync:</strong> Save progress and access across devices (optional login).</li>
                            </ul>
                        </div>
                        <div style="margin-top:8px;">
                            <button type="button" class="try-demo-btn" id="tryDemoBtn">Preview app (no login)</button>
                        </div>

                        <hr style="margin:12px auto; width:80%; border: none; border-top: 1px solid #eef2f7;">
                    </div>
                </div>

                <!-- Original login form (unchanged IDs & inputs) -->
                <h2 class="login-title"></h2>
                <form id="loginForm" class="login-form">
                    <input type="text" id="loginEmail" class="login-input" placeholder="Email address or username" maxlength="100">
                    <input type="password" id="loginPassword" class="login-input" placeholder="Password" maxlength="100">
                    <input type="password" id="loginPasswordConfirm" class="login-input" placeholder="Confirm password (for registration)" maxlength="100" style="display:none">
                    <div style="display:flex; align-items:center; gap:10px; margin-top:5px;">
                        <input type="checkbox" id="rememberMe" />
                        <label for="rememberMe" style="font-size:0.95rem; color:#6c757d;">Remember me on this device</label>
                    </div>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <button type="submit" id="loginBtn" class="login-btn">Login</button>
                    </div>
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px; gap:8px;">
                            <button type="button" class="register-toggle" id="registerToggle" style="background:none;border:none;color:#007bff;padding:6px 8px;cursor:pointer;text-decoration:underline;font-size:0.95rem;">Don't have an account? Register</button>
                            <div style="font-size:0.9rem;"><a href="javascript:void(0)" id="forgotPassword">Forgot password?</a></div>
                        </div>
                    <div id="loginStatus" style="margin-top:10px; font-size:0.9rem; color:#6c757d;"></div>

                </form>
            </div>
        </div>

    <!-- Achievement Popup -->
    <div id="achievementPopup" class="achievement-popup" style="display: none;">
        <div class="achievement-icon" id="achievementIcon">🏆</div>
        <div class="achievement-title" id="achievementTitle">Achievement Unlocked!</div>
        <div class="achievement-desc" id="achievementDesc">You've reached a milestone!</div>
    <button type="button" class="achievement-close" onclick="closeAchievement()">Awesome!</button>
    </div>

    <!-- Allergy Modal -->
    <div id="allergyModal" class="allergy-modal" style="display: none;">
        <div class="allergy-modal-content">
            <h3>⚠️ Report Allergic Reaction</h3>
            <p>Food: <strong id="allergyFoodName"></strong></p>
            <div id="allergyHistory" style="display: none; background: #fffbf0; border: 2px solid #ffc107; border-radius: 10px; padding: 15px; margin: 15px 0;">
                <h4 style="color: #856404; margin-bottom: 10px;">Previous Reactions:</h4>
                <div id="allergyHistoryList"></div>
            </div>
            <div class="allergy-symptoms">
                <div class="symptom-option" data-symptom="rash">Skin rash/hives</div>
                <div class="symptom-option" data-symptom="swelling">Swelling (face/lips)</div>
                <div class="symptom-option" data-symptom="breathing">Breathing difficulty</div>
                <div class="symptom-option" data-symptom="vomiting">Vomiting</div>
                <div class="symptom-option" data-symptom="diarrhea">Diarrhea</div>
                <div class="symptom-option" data-symptom="fussiness">Excessive fussiness</div>
                <div class="symptom-option" data-symptom="other">Other symptoms</div>
            </div>
            <textarea id="allergyNotes" placeholder="Additional notes about the reaction..." rows="3" style="width: 100%; margin: 10px 0; padding: 10px; border: 2px solid #dee2e6; border-radius: 10px;"></textarea>
            <div class="modal-buttons">
                <button type="button" class="modal-btn cancel" onclick="closeAllergyModal()">Cancel</button>
                <button type="button" class="modal-btn save" onclick="saveAllergyReport()">Report Reaction</button>
            </div>
        </div>
    </div>

    <div id="loading" class="loading" style="display: none;">
        <div>🔄 Syncing data...</div>
    </div>

    <div class="container" id="mainApp" style="display: none;">
        <div class="header">
            <div class="user-info">
                👤 <span id="currentUser"></span>
                <button type="button" class="logout-btn" onclick="logout()">Logout</button>
            </div>
            <img src="this.png" alt="Zachary's Weaning Tracker" class="header-logo">
            <p>Track every taste, every try, every triumph!</p>
        </div>
        <div class="tabs">
            <button type="button" class="tab active" onclick="switchTab('summary', event)">📊 Summary</button>
            <button type="button" class="tab" onclick="switchTab('stages', event)">📅 Stages</button>
            <button type="button" class="tab" onclick="switchTab('addMeal', event)">➕ Add Meal</button>
        </div>
        <div class="content">
            <div id="summary" class="tab-content active">
                <div class="summary-grid">
                    <div class="summary-card"><div class="summary-number" id="totalTried">0</div><div class="summary-label">Foods Tried</div></div>
                    <div class="summary-card"><div class="summary-number" id="totalAttempts">0</div><div class="summary-label">Total Attempts</div></div>
                    <div class="summary-card"><div class="summary-number" id="avgRating">0</div><div class="summary-label">Average Rating</div></div>
                    <div class="summary-card"><div class="summary-number" id="favoriteFoods">0</div><div class="summary-label">5-Star Foods</div></div>
                </div>
                <div class="progress-bar"><div class="progress-fill" id="progressBar"></div><div class="progress-text" id="progressText">0% Complete</div></div>
                <div class="controls">
                    <button type="button" class="export-btn" onclick="exportData()">📥 Export Data</button>
                    <button type="button" class="import-btn" onclick="importData()">📤 Import Data</button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImport(this)">
                </div>
                <div class="notes-section"><h3>📝 Notes</h3><textarea class="notes-textarea" id="notesArea" placeholder="Add any notes about Zachary's weaning journey..."></textarea></div>
                <!-- Monetization: donation + ad placeholder -->
                <div class="monetize-row" id="monetizeRow">
                    <a class="buyme-link" href="https://buymeacoffee.com/samholdernq" target="_blank" rel="noopener noreferrer">
                        <img src="https://cdn.buymeacoffee.com/buttons/bmc-new-btn-logo.svg" alt="Buy Me A Coffee" style="height:36px; display:block;">
                        <span class="buyme-label">Buy me a coffee</span>
                    </a>
                    <!-- AdSense placeholder removed -->

                    <!-- Affiliate card: Amazon Associate link + required disclosure -->
                    <div class="affiliate-card" style="display:flex; align-items:center; gap:12px; margin-left:18px;">
                        <a href="https://amzn.to/45wAMkT" target="_blank" rel="noopener noreferrer nofollow" style="display:flex; align-items:center; gap:12px; text-decoration:none; color:inherit;">
                            <img src="ellas.png" alt="Ella's Kitchen product" style="width:72px;height:72px;object-fit:cover;border-radius:8px;border:1px solid #e6e6e6;">
                            <div style="flex:1;">
                                <div style="font-weight:700;">Ella's Kitchen — tasty baby food</div>
                                <div style="font-size:0.9rem; color:#555;">Great deal on some fantastic food developed by another parent, Ella's Kitchen.</div>
                            </div>
                            <div>
                                <span class="affiliate-cta" style="display:inline-block;background:#ff9900;color:#111;padding:8px 12px;border-radius:6px;text-decoration:none;font-weight:700;">Shop on Amazon</span>
                            </div>
                        </a>
                    </div>
                    <div class="affiliate-disclaimer" style="width:100%; margin-top:8px; font-size:0.82rem; color:#444;">
                        <small>Disclosure: As an Amazon Associate I earn from qualifying purchases. This is an affiliate link — thank you for supporting development.</small>
                    </div>
                </div>
            </div>
            <div id="stages" class="tab-content"><div id="stagesContainer"></div></div>
            <div id="addMeal" class="tab-content">
                <div class="add-meal-section">
                    <h3>Add Custom Meal</h3>
                    <p style="text-align: center; margin-bottom: 25px; color: #6c757d;">Add a custom food for Zachary and choose which weaning stage it belongs to.</p>
                    <div class="stage-selector">
                        <div class="stage-option" data-stage="Week 1-2: First Tastes"><strong>Week 1-2</strong><br>First Tastes</div>
                        <div class="stage-option" data-stage="Week 3-4: Building Confidence"><strong>Week 3-4</strong><br>Building Confidence</div>
                        <div class="stage-option" data-stage="Week 5-6: Introducing Lumps"><strong>Week 5-6</strong><br>Introducing Lumps</div>
                        <div class="stage-option" data-stage="Week 7-10: Variety & Textures"><strong>Week 7-10</strong><br>Variety & Textures</div>
                        <div class="stage-option" data-stage="Week 11-16: Chopped & Chunkier"><strong>Week 11-16</strong><br>Chopped & Chunkier</div>
                        <div class="stage-option" data-stage="Month 9-12: Joining Family Meals"><strong>Month 9-12</strong><br>Joining Family Meals</div>
                    </div>
                    <div class="meal-input-section">
                        <input type="text" id="mealName" class="meal-input" placeholder="Enter custom meal name (e.g., 'Homemade applesauce')" maxlength="50">
                        <button type="button" id="addMealBtn" class="add-meal-btn" disabled>Add Meal</button>
                    </div>
                    <!-- Ella's Kitchen pouches quick-add -->
                    <div class="ella-pouches-section">
                        <h4>Ella's Kitchen pouches (quick add)</h4>
                        <div class="pouches-grid" id="pouchesGrid">
                            <!-- JS will populate pouch items here -->
                        </div>
                        <div style="font-size:0.85rem; color:#6c757d;">Select a stage above, then tap a pouch to add it to that stage.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="auto-save-indicator" id="autoSaveIndicator">✅ Synced to cloud!</div>
    <footer style="text-align:center; margin-top:18px; font-size:0.9rem; color:#6c757d;">
        <span>© Zachary's Weaning Tracker</span>
    </footer>
    <!-- Feedback button and modal -->
    <button class="feedback-btn" id="feedbackBtn">💬 Feedback</button>
    <div class="feedback-modal" id="feedbackModal">
        <h3>Send feedback</h3>
        <input type="email" id="feedbackEmail" placeholder="Your email (optional)" style="margin-bottom:8px;">
        <textarea id="feedbackMessage" rows="5" placeholder="Tell me what you think..." ></textarea>
        <div class="feedback-actions">
            <button type="button" class="btn-cancel" id="feedbackCancel">Cancel</button>
            <button type="button" class="btn-submit" id="feedbackSubmit">Send</button>
        </div>
        <div id="feedbackStatus" style="margin-top:8px; font-size:0.9rem; color:#6c757d;"></div>
    </div>
    <div class="info-modal" id="infoModal" style="display:none; position:fixed; z-index:4000; left:50%; top:50%; transform:translate(-50%,-50%); background:white; padding:20px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.2); max-width:600px; width:90%;">
        <button type="button" class="close-info" id="closeInfoBtn" style="position:absolute; right:10px; top:10px;">✖</button>
        <h4 id="infoModalTitle">Info</h4>
        <div id="infoModalBody"></div>
    </div>
    <!-- privacy/cookies UI removed per user request -->
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
        import { getDatabase, ref, onValue, set, push, get } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence, browserSessionPersistence } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCFGP2fcznEA_ubCtcWpQT4Ny99R7U4vHY",
            authDomain: "zachary-weaning.firebaseapp.com",
            databaseURL: "https://zachary-weaning-default-rtdb.firebaseio.com",
            projectId: "zachary-weaning",
            storageBucket: "zachary-weaning.firebasestorage.app",
            messagingSenderId: "135558156277",
            appId: "1:135558156277:web:97055f024492f3a7879abc",
            measurementId: "G-3WWJ4G6XEC"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

    // Global variables
    let currentUser = null;
    let currentUserData = {};
    let isRegistering = false;
    let loginInProgress = false;
    let allergyModalData = {};
    let achievementQueue = [];

        // Weaning stages data (mutable for custom meals)
        let weaningStages = {
            "Week 1-2: First Tastes": ["Apple puree", "Banana", "Carrot puree", "Sweet potato", "Pear puree", "Broccoli puree", "Butternut squash", "Avocado", "Baby rice", "Parsnip puree"],
            "Week 3-4: Building Confidence": ["Cauliflower puree", "Courgette puree", "Mango puree", "Peach puree", "Green beans puree", "Pumpkin puree", "Spinach puree", "Potato puree", "Papaya puree", "Beetroot puree"],
            "Week 5-6: Introducing Lumps": ["Mashed banana", "Well-cooked pasta shapes", "Soft cooked apple pieces", "Mashed sweet potato with lumps", "Soft steamed broccoli florets", "Mashed avocado with texture", "Soft cooked carrot sticks", "Rice with soft vegetables", "Mashed potato with lumps", "Soft cooked pear pieces"],
            "Week 7-10: Variety & Textures": ["Scrambled egg", "Soft cooked chicken strips", "Toast fingers", "Cheese cubes", "Soft cooked fish flakes", "Pasta with sauce", "Steamed vegetable sticks", "Soft fruits in pieces", "Rice cakes", "Yogurt", "Well-cooked lentils", "Soft cooked beef strips"],
            "Week 11-16: Chopped & Chunkier": ["Chopped chicken", "Chopped vegetables", "Harder fruits", "Sandwich pieces", "Mini meatballs", "Chopped hard-boiled egg", "Pasta salad", "Roasted vegetables", "Grated cheese", "Chopped fish", "Bean salads", "Finger foods"],
            "Month 9-12: Joining Family Meals": ["Family meal portions", "Whole fruits", "Raw vegetables", "Nuts (chopped/ground)", "Whole grains", "Spiced foods", "Mixed textures", "Self-feeding foods", "Cup drinking", "Family snacks", "Complex meals", "Adult portions (smaller)"]
        };

        // Info content per stage (displayed when the info icon is clicked)
        const infoContent = {
            "Week 1-2: First Tastes": {
                title: 'Week 1-2 — First Tastes',
                body: `
                    <h4>When</h4>
                    <p>Start introducing single-ingredient purees and smooth textures once your baby is developmentally ready to accept solids (usually around 4-6 months but follow your healthcare professional's advice).</p>
                    <h4>How much</h4>
                    <p>Begin with 1-2 teaspoons per offering, gradually increasing to a tablespoon as interest grows. Watch cues for fullness and enjoyment.</p>
                    <h4>Water</h4>
                    <p>Offer small sips of cooled, boiled water from an open cup or spout cup with meals; focus on breastmilk/formula as the main drink at this stage.</p>
                    <h4>Consistency</h4>
                    <p>Smooth, runny purees with no lumps; single-ingredient textures to start.</p>
                    <p style="margin-top:8px; font-weight:bold;">All children are different — if you are worried about feeding or reactions, speak to your doctor, health visitor, or paediatrician.</p>
                `
            },
            "Week 3-4: Building Confidence": {
                title: 'Week 3-4 — Building Confidence',
                body: `
                    <h4>When</h4>
                    <p>Continue daily exposures to a wider range of purees and introduce gentle flavour combinations.</p>
                    <h4>How much</h4>
                    <p>Offer 1-3 tablespoons; allow baby to lead intake. Don’t force feed; responsive feeding helps acceptance.</p>
                    <h4>Water</h4>
                    <p>Small sips (15–30ml) with meals are fine; milk remains primary source of hydration and nutrition.</p>
                    <h4>Consistency</h4>
                    <p>Smoother purees with slightly thicker texture than first feeds; still no lumps.</p>
                    <p style="margin-top:8px; font-weight:bold;">All children are different — if you are worried, speak to your doctor or health visitor.</p>
                `
            },
            "Week 5-6: Introducing Lumps": {
                title: 'Week 5-6 — Introducing Lumps',
                body: `
                    <h4>When</h4>
                    <p>Introduce thicker purees and mashed textures when your baby shows readiness for more texture (can sit with support and manage mouth movement).</p>
                    <h4>How much</h4>
                    <p>Portions may increase to 2–4 tablespoons; continue to follow baby’s cues and maintain milk feeds as usual.</p>
                    <h4>Water</h4>
                    <p>Offer small amounts of water with meals (about 20–40ml) to help with swallowing textured foods.</p>
                    <h4>Consistency</h4>
                    <p>Mashed textures with small, soft lumps; avoid hard pieces. Ensure food is soft and easily mashable between fingers.</p>
                    <p style="margin-top:8px; font-weight:bold;">All children are different — if you are worried, speak to your doctor or health visitor.</p>
                `
            },
            "Week 7-10: Variety & Textures": {
                title: 'Week 7-10 — Variety & Textures',
                body: `
                    <h4>When</h4>
                    <p>Introduce varied tastes and textures, including soft finger foods and protein sources when baby can sit steadily and self-feed.</p>
                    <h4>How much</h4>
                    <p>Serve 3–4 small spoonfuls/finger-food pieces per offering, increasing as appetite and skills grow. Let baby guide pace and amount.</p>
                    <h4>Water</h4>
                    <p>Offer water in small amounts (30–60ml) with meals; focus on regular sips from a cup to practise drinking skills.</p>
                    <h4>Consistency</h4>
                    <p>Soft cooked pieces, mashed with lumps, and soft finger-food shapes that baby can grasp and gum safely.</p>
                    <p style="margin-top:8px; font-weight:bold;">All children are different — if you are worried, speak to your doctor or health visitor.</p>
                `
            },
            "Week 11-16: Chopped & Chunkier": {
                title: 'Week 11-16 — Chopped & Chunkier',
                body: `
                    <h4>When</h4>
                    <p>Gradually move towards chopped family foods and chunkier textures as chewing and swallowing skills mature.</p>
                    <h4>How much</h4>
                    <p>Offer several small portions over the meal (finger-food portions or spoon-fed bits); allow baby to explore and self-feed increasing amounts.</p>
                    <h4>Water</h4>
                    <p>Offer water freely with meals (50–100ml depending on age and climate); encourage cup use.</p>
                    <h4>Consistency</h4>
                    <p>Soft chopped pieces, small, manageable chunks — avoid hard, small round foods (e.g., whole grapes, nuts) unless prepared safely.</p>
                    <p style="margin-top:8px; font-weight:bold;">All children are different — if you are worried, speak to your doctor or health visitor.</p>
                `
            },
            "Month 9-12: Joining Family Meals": {
                title: 'Month 9-12 — Joining Family Meals',
                body: `
                    <h4>When</h4>
                    <p>Encourage your baby to take part in family meals, offering age-appropriate portions and textures that match family dishes adjusted for safety.</p>
                    <h4>How much</h4>
                    <p>Portions will vary but generally are small pieces that make up part of a meal; breastmilk/formula remains important.</p>
                    <h4>Water</h4>
                    <p>Offer water regularly with meals (60–120ml per meal depending on intake); milk remains primary hydration between meals.</p>
                    <h4>Consistency</h4>
                    <p>More varied textures and small family food pieces; focus on safe sizes and soft cooking methods.</p>
                    <p style="margin-top:8px; font-weight:bold;">All children are different — if you are worried, speak to your doctor or health visitor.</p>
                `
            }
        };

    // Data storage
    let weaningData = {};
    let allergyData = {};
    let notes = '';
    let selectedStage = null;
    let achievements = {};
    // Keep track of which stages are open so we can preserve state when parts of the UI re-render
    let openStages = new Set();

        // Achievement definitions
        const achievementList = {
            firstFood: { icon: '🍎', title: 'First Bite!', desc: 'Tried your very first food!', trigger: (data) => getTotalTried(data) === 1 },
            fiveFoods: { icon: '🌈', title: 'Food Explorer!', desc: 'Tried 5 different foods!', trigger: (data) => getTotalTried(data) === 5 },
            tenFoods: { icon: '🏆', title: 'Taste Adventurer!', desc: 'Tried 10 different foods!', trigger: (data) => getTotalTried(data) === 10 },
            twentyFoods: { icon: '🎖️', title: 'Super Taster!', desc: 'Tried 20 different foods!', trigger: (data) => getTotalTried(data) === 20 },
            firstLove: { icon: '❤️', title: 'Found a Favorite!', desc: 'Gave your first 5-star rating!', trigger: (data) => getFiveStarCount(data) === 1 },
            fiveLoves: { icon: '💝', title: 'Food Lover!', desc: 'Found 5 favorite foods!', trigger: (data) => getFiveStarCount(data) === 5 },
            persistent: { icon: '💪', title: 'Never Give Up!', desc: 'Tried the same food 5 times!', trigger: (data) => hasRepeatedFood(data, 5) },
            champion: { icon: '🥇', title: 'Weaning Champion!', desc: 'Tried 50 different foods!', trigger: (data) => getTotalTried(data) === 50 }
        };

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            applyFeatureMode();
            setupLoginSystem();
            // Ensure feedback handlers are attached after DOM is ready
            try { setupFeedback(); } catch (e) { console.error('setupFeedback init error', e); }
        });

        // Feature flag / UI mode initializer (stubbed to avoid ReferenceError)
        // You can extend this to toggle dev features or alternate UI modes.
        function applyFeatureMode() {
            // Placeholder: ensure any optional features are turned off by default
            // e.g., window.FEATURE_DEBUG = false;
            return;
        }

        // Setup Firebase Auth
        let auth = null;

        function setupLoginSystem() {
            auth = getAuth(app);
            // Do not set persistence globally here. We'll set it at login based on "Remember me".

            // Attach UI handlers
            // login button is submit inside the form; form submit handler will handle login
            const regToggle = document.getElementById('registerToggle');
            if (regToggle) regToggle.addEventListener('click', toggleRegister);
            const forgot = document.getElementById('forgotPassword');
            if (forgot) forgot.addEventListener('click', handleForgotPassword);

            // Use form submit to handle Enter and button clicks reliably
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    if (loginInProgress) return; // avoid double submits
                    loginInProgress = true;
                    handleLogin().finally(() => { loginInProgress = false; });
                });
            }

            // ...existing code...

            // ...existing code...

            // Inputs will submit via the form; no per-input Enter handlers needed

            // React to auth state changes
            onAuthStateChanged(getAuth(app), (user) => {
                // If the app is opened in demo preview mode, do not override the UI
                // This keeps the preview visible even if auth state updates fire.
                if (window._DEMO_PREVIEW) return;
                if (user) {
                    currentUser = user.uid;
                    currentUserData = {};
                    document.getElementById('currentUser').textContent = user.email || currentUser;
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                    loadFromFirebase();
                    setupAddMealTab();
                    setupRealtimeListeners();
                } else {
                    currentUser = null;
                    document.getElementById('currentUser').textContent = '';
                    document.getElementById('loginScreen').style.display = 'flex';
                    document.getElementById('mainApp').style.display = 'none';
                }
            });

            // Toggle register/login UI
            function toggleRegister() {
                isRegistering = !isRegistering;
                const btn = document.getElementById('loginBtn');
                const toggle = document.getElementById('registerToggle');
                const confirm = document.getElementById('loginPasswordConfirm');
                if (isRegistering) {
                    if (btn) btn.textContent = 'Register';
                    if (toggle) toggle.textContent = 'Already have an account? Login';
                    if (confirm) confirm.style.display = 'block';
                } else {
                    if (btn) btn.textContent = 'Login';
                    if (toggle) toggle.textContent = "Don't have an account? Register";
                    if (confirm) { confirm.style.display = 'none'; confirm.value = ''; }
                }
            }

        }

            async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const confirm = document.getElementById('loginPasswordConfirm').value.trim();
            const statusEl = document.getElementById('loginStatus');

            if (!email || !password) {
                if (statusEl) statusEl.textContent = 'Please enter both email and password';
                return;
            }

            if (isRegistering && password !== confirm) {
                if (statusEl) statusEl.textContent = 'Passwords do not match';
                return;
            }

            try {
                if (statusEl) statusEl.textContent = isRegistering ? 'Registering account...' : 'Signing in...';
                showLoading(true);

                // Legacy username/password: if identifier doesn't contain '@', treat as username
                if (email.indexOf('@') === -1) {
                    const nameKey = email.replace(/[^a-zA-Z0-9_-]/g, '').toLowerCase();
                    try {
                        // 1) Check usersByName mapping
                        const nameRef = ref(database, `usersByName/${nameKey}`);
                        const snap = await get(nameRef);
                        let uid = null;
                        let userSnapshot = null;
                        if (snap.exists()) {
                            const mapping = snap.val();
                            uid = mapping.uid;
                        }

                        // 2) If not found, check users/<nameKey>
                        if (!uid) {
                            const directRef = ref(database, `users/${nameKey}`);
                            const directSnap = await get(directRef);
                            if (directSnap.exists()) {
                                uid = nameKey;
                            }
                        }

                        // 3) As a last resort, scan users for a username/displayName match (case-insensitive)
                        if (!uid) {
                            const usersRef = ref(database, `users`);
                            const usersSnap = await get(usersRef);
                            if (usersSnap.exists()) {
                                const usersObj = usersSnap.val();
                                for (const [k, v] of Object.entries(usersObj)) {
                                    const candidateNames = [ (v.username||''), (v.name||''), (v.displayName||''), (v.email||'') ];
                                    if (candidateNames.map(x=>String(x).toLowerCase()).includes(nameKey)) {
                                        uid = k;
                                        userSnapshot = { key: k, val: v };
                                        break;
                                    }
                                }
                            }
                        }

                        if (!uid) {
                            if (statusEl) statusEl.textContent = `User not found for "${email}"`;
                            console.debug('Legacy login: no uid found for', { identifier: email, nameKey });
                            showLoading(false);
                            return;
                        }

                        // fetch final user data if not already
                        if (!userSnapshot) {
                            const finalSnap = await get(ref(database, `users/${uid}`));
                            if (!finalSnap.exists()) { if (statusEl) statusEl.textContent = 'User record missing'; showLoading(false); return; }
                            userSnapshot = { key: uid, val: finalSnap.val() };
                        }

                        // Accept common password fields: password, pwd, pass
                        const stored = userSnapshot.val;
                        const candidates = ['password','pwd','pass','loginPassword','pw','hash'];
                        let possible = '';
                        let matchedField = null;
                        for (const f of candidates) {
                            if (stored[f]) { possible = stored[f]; matchedField = f; break; }
                        }
                        if (!possible) {
                            // try to find any string field
                            for (const [kField, vField] of Object.entries(stored)) {
                                if (typeof vField === 'string') { possible = vField; matchedField = kField; break; }
                            }
                        }
                        if (!possible) {
                            if (statusEl) statusEl.textContent = `No password field found for user ${uid || nameKey}`;
                            console.debug('Legacy login: user record has no string fields to verify', { uid, fields: Object.keys(stored || {}) });
                            showLoading(false);
                            return;
                        }

                        // Helper: load bcryptjs dynamically when needed
                        function loadBcrypt() {
                            return new Promise((resolve, reject) => {
                                if (window.bcrypt && window.bcrypt.compare) return resolve(window.bcrypt);
                                const src = 'https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js';
                                const s = document.createElement('script');
                                s.src = src;
                                s.onload = () => {
                                    // bcrypt is exposed as dcodeIO_bcrypt or bcrypt
                                    const b = window.dcodeIO_bcrypt || window.bcrypt || window.dcodeIO_bcrypt_module;
                                    if (b) return resolve(b);
                                    if (window.bcrypt) return resolve(window.bcrypt);
                                    resolve(window.bcrypt || window.dcodeIO_bcrypt);
                                };
                                s.onerror = reject;
                                document.head.appendChild(s);
                            });
                        }

                        async function verifySha256(salt, expectedHex, pw) {
                            const enc = new TextEncoder();
                            const data = enc.encode(salt + pw);
                            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                            const hashArray = Array.from(new Uint8Array(hashBuffer));
                            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                            return hashHex === expectedHex.toLowerCase();
                        }

                        // If stored looks like bcrypt hash ($2a$... / $2b$...)
                        if (typeof possible === 'string' && possible.startsWith('$2')) {
                            try {
                                const bcrypt = await loadBcrypt();
                                const ok = await new Promise((res) => bcrypt.compare(password, possible, function(err, result){ if (err) { console.error(err); return res(false); } res(result); }));
                                if (!ok) { 
                                    if (statusEl) statusEl.textContent = `Incorrect username or password (checked field: ${matchedField || 'unknown'}, algo: bcrypt)`; 
                                    console.debug('Legacy login bcrypt mismatch', { uid, matchedField });
                                    showLoading(false); 
                                    return; 
                                }
                            } catch (e) {
                                console.error('Bcrypt verify failed', e);
                                if (statusEl) statusEl.textContent = `Login failed (bcrypt verify) - field:${matchedField || 'unknown'}`; showLoading(false); return;
                            }
                        } else if (typeof possible === 'string' && possible.startsWith('sha256$')) {
                            // format: sha256$<salt>$<hexhash>
                            const parts = possible.split('$');
                            if (parts.length >= 3) {
                                const salt = parts[1];
                                const hex = parts[2];
                                const ok = await verifySha256(salt, hex, password);
                                if (!ok) { 
                                    if (statusEl) statusEl.textContent = `Incorrect username or password (checked field: ${matchedField || 'unknown'}, algo: sha256)`; 
                                    console.debug('Legacy login sha256 mismatch', { uid, matchedField });
                                    showLoading(false); 
                                    return; 
                                }
                            } else {
                                if (statusEl) statusEl.textContent = `Invalid stored hash format - field:${matchedField || 'unknown'}`; showLoading(false); return;
                            }
                        } else {
                            // plain-text fallback (legacy)
                            if (possible !== password) {
                                // As a last-ditch effort, search any string field in stored for a match
                                let foundInField = false;
                                for (const [kField, vField] of Object.entries(stored)) {
                                    if (typeof vField === 'string' && vField === password) { foundInField = true; matchedField = kField; break; }
                                }
                                if (!foundInField) { 
                                    if (statusEl) statusEl.textContent = `Incorrect username or password (checked field: ${matchedField || 'unknown'})`; 
                                    console.debug('Legacy login plaintext mismatch - scanned fields', { uid, checkedField: matchedField, fields: Object.keys(stored || {}) });
                                    showLoading(false); 
                                    return; 
                                }
                            }
                        }

                        // Success
                        currentUser = uid;
                        document.getElementById('currentUser').textContent = stored.displayName || nameKey;
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('mainApp').style.display = 'block';
                        await loadFromFirebase();
                        setupAddMealTab();
                        setupRealtimeListeners();
                        if (statusEl) statusEl.textContent = 'Logged in';
                        showLoading(false);
                        return;
                    } catch (e) {
                        console.error('Legacy login error', e);
                        if (statusEl) statusEl.textContent = `Login failed (legacy): ${e && e.message ? e.message : 'unknown error'}`;
                        showLoading(false);
                        return;
                    }
                }

                // Email/password path (Firebase Auth)
                // Determine persistence: rememberMe -> local, otherwise session
                try {
                    const remember = document.getElementById('rememberMe') && document.getElementById('rememberMe').checked;
                    await setPersistence(getAuth(app), remember ? browserLocalPersistence : browserSessionPersistence);
                } catch (pErr) {
                    console.warn('Could not set persistence', pErr);
                }

                if (isRegistering) {
                    // Create account with Firebase Auth
                    const cred = await createUserWithEmailAndPassword(getAuth(app), email, password);
                    currentUser = cred.user.uid;
                    // Initialize a minimal DB node for the user (do NOT store password)
                    const userRef = ref(database, `users/${currentUser}`);
                    await set(userRef, { createdAt: new Date().toISOString(), weaningData: {}, allergyData: {}, notes: '', achievements: {} });
                    if (statusEl) statusEl.textContent = `Account created for ${email}`;
                } else {
                    // Sign in
                    const cred = await signInWithEmailAndPassword(getAuth(app), email, password);
                    currentUser = cred.user.uid;
                }

                // On success, auth state change listener will hide login and load data
            } catch (err) {
                console.error('Auth error:', err);
                if (statusEl) statusEl.textContent = `Authentication failed${err && err.message ? ': ' + err.message : ''}`;
                // If trying to register but email already used, offer reset
                if (isRegistering && err && err.code === 'auth/email-already-in-use') {
                    if (confirm('That email is already registered. Send a password reset email?')) {
                        try { await sendPasswordResetEmail(getAuth(app), email); alert('Reset email sent.'); } catch(e){ console.error(e); alert('Could not send reset email'); }
                    }
                }
            } finally {
                showLoading(false);
            }
        }

        async function handleForgotPassword(e) {
            e && e.preventDefault();
            const email = document.getElementById('loginEmail').value.trim();
            if (!email) { alert('Enter your email in the email field to receive a password reset link.'); return; }
            try {
                await sendPasswordResetEmail(getAuth(app), email);
                alert('Password reset email sent. Check your inbox.');
            } catch (err) {
                console.error('Reset error:', err);
                alert(err && err.message ? err.message : 'Could not send password reset email');
            }
        }

        window.logout = function() {
            if (auth) {
                signOut(auth).catch(err => console.error('Sign out error', err));
            }
            currentUser = null;
            currentUserData = {};
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginPasswordConfirm').value = '';
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            weaningData = {};
            allergyData = {};
            notes = '';
            achievements = {};
        }

        // Load data from Firebase
        async function loadFromFirebase() {
            if (!currentUser) return;
            
            showLoading(true);
            try {
                const userRef = ref(database, `users/${currentUser}`);
                const userSnapshot = await get(userRef);
                
                if (userSnapshot.exists()) {
                    currentUserData = userSnapshot.val();
                    weaningData = currentUserData.weaningData || {};
                    allergyData = currentUserData.allergyData || {};
                    notes = currentUserData.notes || '';
                    achievements = currentUserData.achievements || {};
                    
                    if (currentUserData.customStages) {
                        weaningStages = { ...weaningStages, ...currentUserData.customStages };
                    }

                    document.getElementById('notesArea').value = notes;
                }

                renderStages();
                updateSummary();
                setupNotesListener();
                showLoading(false);
            } catch (error) {
                console.error('Error loading from Firebase:', error);
                showLoading(false);
                showAutoSave('❌ Connection error - using local data');
            }
        }

        // Setup realtime listeners for changes
        function setupRealtimeListeners() {
            if (!currentUser) return;

            const userRef = ref(database, `users/${currentUser}`);
            onValue(userRef, (snapshot) => {
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    weaningData = userData.weaningData || {};
                    allergyData = userData.allergyData || {};
                    
                    if (userData.notes !== notes) {
                        notes = userData.notes || '';
                        document.getElementById('notesArea').value = notes;
                    }
                    
                    if (userData.customStages) {
                        weaningStages = { ...weaningStages, ...userData.customStages };
                        renderStages();
                    }
                    
                    achievements = userData.achievements || {};
                    updateSummary();
                    updateAllFoodDisplays();
                }
            });
        }

        // Save data to Firebase
        async function saveToFirebase(dataType, data) {
            if (!currentUser) return;

            try {
                const userRef = ref(database, `users/${currentUser}/${dataType}`);
                await set(userRef, data);
                
                if (dataType === 'weaningData') {
                    checkAchievements();
                }
                
                showAutoSave('✅ Synced to cloud!');
            } catch (error) {
                console.error('Error saving to Firebase:', error);
                showAutoSave('❌ Sync failed');
            }
        }

        // Achievement System
        function checkAchievements() {
            Object.entries(achievementList).forEach(([key, achievement]) => {
                if (!achievements[key] && achievement.trigger(weaningData)) {
                    achievements[key] = {
                        unlocked: true,
                        date: new Date().toISOString()
                    };
                    
                    showAchievement(achievement);
                    saveToFirebase('achievements', achievements);
                }
            });
        }

        function showAchievement(achievement) {
            document.getElementById('achievementIcon').textContent = achievement.icon;
            document.getElementById('achievementTitle').textContent = achievement.title;
            document.getElementById('achievementDesc').textContent = achievement.desc;
            document.getElementById('achievementPopup').style.display = 'block';
        }

        window.closeAchievement = function() {
            document.getElementById('achievementPopup').style.display = 'none';
        }

        // Helper functions for achievements
        function getTotalTried(data) {
            return Object.values(data).filter(item => item.tried).length;
        }

        function getFiveStarCount(data) {
            return Object.values(data).filter(item => item.rating === 5).length;
        }

        function hasRepeatedFood(data, count) {
            return Object.values(data).some(item => item.attempts >= count);
        }

        // Allergy System with History and UK Date Format
        window.openAllergyModal = function(stageName, foodName) {
            allergyModalData = { stage: stageName, food: foodName };
            document.getElementById('allergyFoodName').textContent = foodName;
            
            // Check for existing allergy history
            const allergyKey = `${stageName}-${foodName}`;
            const historyDiv = document.getElementById('allergyHistory');
            const historyList = document.getElementById('allergyHistoryList');
            
            if (allergyData[allergyKey]) {
                // Convert existing single report to array format for backwards compatibility
                if (!Array.isArray(allergyData[allergyKey])) {
                    allergyData[allergyKey] = [allergyData[allergyKey]];
                }
                
                historyDiv.style.display = 'block';
                historyList.innerHTML = '';
                
                allergyData[allergyKey].forEach((reaction, index) => {
                    const date = new Date(reaction.date);
                    const ukDate = date.toLocaleDateString('en-GB', {
                        day: '2-digit',
                        month: '2-digit', 
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const historyItem = document.createElement('div');
                    historyItem.style.cssText = 'margin-bottom: 10px; padding: 8px; background: rgba(255,193,7,0.1); border-radius: 5px; font-size: 0.9rem;';
                    historyItem.innerHTML = `
                        <strong>📅 ${ukDate}</strong><br>
                        <strong>Symptoms:</strong> ${reaction.symptoms.join(', ')}<br>
                        ${reaction.notes ? `<strong>Notes:</strong> ${reaction.notes}` : ''}
                    `;
                    historyList.appendChild(historyItem);
                });
            } else {
                historyDiv.style.display = 'none';
            }
            
            document.getElementById('allergyModal').style.display = 'block';
        }

        window.closeAllergyModal = function() {
            document.getElementById('allergyModal').style.display = 'none';
            // Clear selections
            document.querySelectorAll('.symptom-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.getElementById('allergyNotes').value = '';
        }

        // Symptom selection
        document.addEventListener('click', function(e) {
            if (e.target.matches('.symptom-option')) {
                e.target.classList.toggle('selected');
            }
        });

        // Info modal close handler
        const closeInfoBtnEl = document.getElementById('closeInfoBtn');
        if (closeInfoBtnEl) {
            closeInfoBtnEl.addEventListener('click', function() {
                const modal = document.getElementById('infoModal');
                if (modal) modal.style.display = 'none';
            });
        }

        // Close info modal on Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('infoModal');
                if (modal) modal.style.display = 'none';
            }
        });

        window.saveAllergyReport = function() {
            const selectedSymptoms = Array.from(document.querySelectorAll('.symptom-option.selected'))
                .map(opt => opt.dataset.symptom);
            const notes = document.getElementById('allergyNotes').value;
            
            if (selectedSymptoms.length === 0) {
                alert('Please select at least one symptom');
                return;
            }

            const allergyKey = `${allergyModalData.stage}-${allergyModalData.food}`;
            const newReaction = {
                symptoms: selectedSymptoms,
                notes: notes,
                date: new Date().toISOString()
            };

            // Initialize as array or add to existing array
            if (!allergyData[allergyKey]) {
                allergyData[allergyKey] = [newReaction];
            } else if (Array.isArray(allergyData[allergyKey])) {
                allergyData[allergyKey].push(newReaction);
            } else {
                // Convert old single format to array
                allergyData[allergyKey] = [allergyData[allergyKey], newReaction];
            }

            // Mark food item visually
            const foodId = `${allergyModalData.stage}-${allergyModalData.food}`.replace(/[^a-zA-Z0-9]/g, '');
            const foodElement = document.getElementById(`food-${foodId}`);
            if (foodElement) {
                foodElement.classList.add('allergy-flagged');
            }

            saveToFirebase('allergyData', allergyData);
            closeAllergyModal();
            showAutoSave('⚠️ Allergy reaction reported!');
        }

        // Tab switching functionality
        window.switchTab = function(tabName, evt) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            const tabEl = document.getElementById(tabName);
            if (tabEl) tabEl.classList.add('active');
            if (evt && evt.currentTarget) {
                try { evt.currentTarget.classList.add('active'); } catch(e){}
            }
            if (tabName === 'stages') renderStages();
        }

        // Setup add meal tab functionality
        function setupAddMealTab() {
            const stageOptions = document.querySelectorAll('.stage-option');
            const mealInput = document.getElementById('mealName');
            const addBtn = document.getElementById('addMealBtn');

            stageOptions.forEach(option => {
                option.addEventListener('click', function() {
                    stageOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedStage = this.getAttribute('data-stage');
                    updateAddButton();
                });
            });

            mealInput.addEventListener('input', updateAddButton);
            addBtn.addEventListener('click', addCustomMeal);

            // Render Ella's pouches and wire up quick-add buttons
            renderEllaPouches();
        }

        // Ella's Kitchen pouches list
        const ellaPouches = [
            'Bangers and Mash', 'Beef Stew', 'Chicken and Rice Casserole', 'Vegetable & Lentil Bake', 'Spag Bol', 'Veggie Feast', 'Chicken Veg', 'Fish Pie', 'Lamb Roast Dinner', 'Cheesy Pie', 'Rice Pudding', 'Lamb Couscous'
        ];

        function renderEllaPouches() {
            const grid = document.getElementById('pouchesGrid');
            if (!grid) return;
            grid.innerHTML = '';

            ellaPouches.forEach(pouch => {
                const item = document.createElement('div');
                item.className = 'pouch-item';
                item.innerHTML = `
                    <div class="pouch-name">${pouch}</div>
                    <button type="button" class="pouch-add-btn" data-pouch="${pouch}">Add</button>
                `;
                grid.appendChild(item);
            });

            // Attach click handler (event delegation)
            grid.addEventListener('click', function(e) {
                const btn = e.target.closest('.pouch-add-btn');
                if (!btn) return;
                const pouch = btn.dataset.pouch;
                if (!selectedStage) {
                    alert('Please select a stage above to add this pouch to.');
                    return;
                }
                addPouchToStage(selectedStage, pouch);
            });
        }

        async function addPouchToStage(stageName, pouchName) {
            // Ensure stage exists
            if (!weaningStages[stageName]) {
                weaningStages[stageName] = [];
            }

            // Avoid duplicates
            if (weaningStages[stageName].includes(pouchName)) {
                showAutoSave(`\"${pouchName}\" already in ${stageName}`);
                return;
            }

            weaningStages[stageName].push(pouchName);

            // Persist customStages (only push the modified stage to Firebase to keep sizes small)
            const customStages = {};
            customStages[stageName] = weaningStages[stageName];
            await saveToFirebase('customStages', { ...(currentUserData.customStages||{}), ...customStages });

            showAutoSave(`Added \"${pouchName}\" to ${stageName}`);

            // If currently viewing stages, re-render
            if (document.getElementById('stages').classList.contains('active')) {
                renderStages();
            }
        }

        function updateAddButton() {
            const mealInput = document.getElementById('mealName');
            const addBtn = document.getElementById('addMealBtn');
            const isValid = selectedStage && mealInput.value.trim().length > 0;
            addBtn.disabled = !isValid;
        }

        async function addCustomMeal() {
            const mealInput = document.getElementById('mealName');
            const mealName = mealInput.value.trim();
            
            if (selectedStage && mealName) {
                weaningStages[selectedStage].push(mealName);
                
                const customStages = {};
                Object.keys(weaningStages).forEach(stage => {
                    if (weaningStages[stage].includes(mealName)) {
                        customStages[stage] = weaningStages[stage];
                    }
                });
                
                await saveToFirebase('customStages', customStages);
                
                mealInput.value = '';
                document.querySelectorAll('.stage-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                const addedStage = selectedStage; // capture before clearing
                selectedStage = null;
                updateAddButton();

                showAutoSave(`Added "${mealName}" to ${addedStage}`);
                
                if (document.getElementById('stages').classList.contains('active')) {
                    renderStages();
                }
            }
        }

        // Render all stages
        function renderStages() {
            const container = document.getElementById('stagesContainer');
            container.innerHTML = '';

            Object.entries(weaningStages).forEach(([stageName, foods]) => {
                const stageDiv = document.createElement('div');
                stageDiv.className = 'stage';
                
                const triedCount = foods.filter(food => getFoodData(stageName, food).tried).length;
                const progressText = `${triedCount}/${foods.length} tried`;

                stageDiv.innerHTML = `
                    <div class="stage-header" data-stage="${stageName}">
                        <h3>${stageName}</h3>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div class="stage-progress">${progressText}</div>
                            <button type="button" class="stage-info info-icon" data-stage="${stageName}" title="Stage info" aria-label="Stage information">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                    <circle cx="12" cy="12" r="10" stroke="#ffffff" stroke-width="1.5" fill="none" />
                                    <rect x="11" y="10" width="2" height="6" rx="1" fill="#ffffff" />
                                    <rect x="11" y="7" width="2" height="2" rx="1" fill="#ffffff" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="stage-content" id="stage-${stageName.replace(/[^a-zA-Z0-9]/g, '')}">
                        ${foods.map(food => createFoodItemHTML(stageName, food)).join('')}
                    </div>
                `;

                // If this stage was previously open, restore the open class
                if (openStages.has(stageName)) {
                    stageDiv.classList.add('open');
                }

                container.appendChild(stageDiv);
                // Attach click listeners after appending
                const header = stageDiv.querySelector('.stage-header');
                if (header) header.addEventListener('click', function(e) {
                    // Ignore clicks that come from interactive children (buttons/links)
                    if (e.target.closest('button, a')) return;
                    toggleStage(this.dataset.stage);
                });
                const infoBtn = stageDiv.querySelector('.stage-info');
                if (infoBtn) infoBtn.addEventListener('click', function(e) {
                    e.preventDefault(); e.stopPropagation();
                    const stage = this.dataset.stage;
                    const info = infoContent[stage] || { title: 'Info', body: '<p>No information available.</p>' };
                    document.getElementById('infoModalTitle').textContent = info.title;
                    document.getElementById('infoModalBody').innerHTML = info.body;
                    document.getElementById('infoModal').style.display = 'block';
                }, true);
            });
        }

        // Toggle stage visibility
        window.toggleStage = function(stageName) {
            // Find the parent stage element by dataset
            const safeId = stageName.replace(/[^a-zA-Z0-9]/g, '');
            const stageEl = document.querySelector(`.stage [id="stage-${safeId}"]`);
            if (!stageEl) return;

            const stageContainer = stageEl.closest('.stage');
            if (!stageContainer) return;

            const isOpen = stageContainer.classList.toggle('open');
            if (isOpen) {
                openStages.add(stageName);
            } else {
                openStages.delete(stageName);
            }
        }

        // Create food item HTML
        function createFoodItemHTML(stageName, foodName) {
            const foodData = getFoodData(stageName, foodName);
            const allergyKey = `${stageName}-${foodName}`;
            const hasAllergy = allergyData[allergyKey];
            const foodId = `${stageName}-${foodName}`.replace(/[^a-zA-Z0-9]/g, '');

            return `
                <div class="food-item ${hasAllergy ? 'allergy-flagged' : ''}" id="food-${foodId}">
                    <div class="food-name">${foodName}</div>
                    ${hasAllergy ? '<div class="allergy-flag" title="Allergic reaction reported">⚠️</div>' : ''}
                    <div class="food-controls">
                        <div class="tried-container">
                            <input type="checkbox" class="tried-checkbox" 
                                   data-stage="${stageName}" data-food="${foodName}"
                                   ${foodData.tried ? 'checked' : ''}>
                            <span style="cursor: default;">Tried it</span>
                        </div>
                        <div class="counter-container">
                            <button type="button" class="counter-btn" data-stage="${stageName}" data-food="${foodName}" data-action="decrease">-</button>
                            <span class="counter-display">${foodData.attempts || 0}</span>
                            <button type="button" class="counter-btn" data-stage="${stageName}" data-food="${foodName}" data-action="increase">+</button>
                            <label>attempts</label>
                        </div>
                        <div class="rating-container">
                            ${[1,2,3,4,5].map(rating => 
                                `<span class="star ${foodData.rating >= rating ? 'filled' : ''}" 
                                       data-stage="${stageName}" data-food="${foodName}" data-rating="${rating}">⭐</span>`
                            ).join('')}
                        </div>
                        <button type="button" class="allergy-btn" data-stage="${stageName}" data-food="${foodName}">
                            ⚠️ Report Reaction
                        </button>
                    </div>
                </div>
            `;
        }

        // Event delegation for food controls
        document.addEventListener('click', function(e) {
            // Prevent default/page jump for any interactive controls
            if (e.target.matches('.counter-btn') || e.target.matches('.tried-checkbox') || e.target.matches('.star') || e.target.matches('.allergy-btn')) {
                e.preventDefault();
            }

            if (e.target.matches('.tried-checkbox')) {
                e.stopPropagation();
                const { stage, food } = e.target.dataset;
                const checked = e.target.checked;

                // When user checks tried, ensure attempts is at least 1
                const currentAttempts = getFoodData(stage, food).attempts || 0;
                if (checked && currentAttempts === 0) {
                    updateFoodData(stage, food, 'attempts', 1);
                }

                // When user unchecks tried, set attempts to 0
                if (!checked) {
                    updateFoodData(stage, food, 'attempts', 0);
                }

                updateFoodData(stage, food, 'tried', checked);
                updateFoodItemDisplay(stage, food);
                updateSummary();
                saveToFirebase('weaningData', weaningData);
            }

            if (e.target.matches('.counter-btn')) {
                e.stopPropagation();
                const { stage, food, action } = e.target.dataset;
                const currentAttempts = getFoodData(stage, food).attempts || 0;
                const newAttempts = action === 'increase' 
                    ? currentAttempts + 1 
                    : Math.max(0, currentAttempts - 1);

                updateFoodData(stage, food, 'attempts', newAttempts);

                // Auto-check tried when attempts become 1 or more
                if (newAttempts > 0) {
                    updateFoodData(stage, food, 'tried', true);
                } else {
                    updateFoodData(stage, food, 'tried', false);
                }

                updateFoodItemDisplay(stage, food);
                updateSummary();
                saveToFirebase('weaningData', weaningData);
            }

            if (e.target.matches('.star')) {
                e.stopPropagation();
                const { stage, food, rating } = e.target.dataset;
                updateFoodData(stage, food, 'rating', parseInt(rating));
                updateFoodItemDisplay(stage, food);
                updateSummary();
                saveToFirebase('weaningData', weaningData);
            }

            if (e.target.matches('.allergy-btn')) {
                e.stopPropagation();
                const stage = e.target.dataset.stage;
                const food = e.target.dataset.food;
                openAllergyModal(stage, food);
            }
        });

        // Update specific food item display
        function updateFoodItemDisplay(stageName, foodName) {
            const foodData = getFoodData(stageName, foodName);
            const foodId = `${stageName}-${foodName}`.replace(/[^a-zA-Z0-9]/g, '');
            const foodElement = document.getElementById(`food-${foodId}`);
            
            if (foodElement) {
                const counterDisplay = foodElement.querySelector('.counter-display');
                if (counterDisplay) {
                    counterDisplay.textContent = foodData.attempts || 0;
                }
                
                const stars = foodElement.querySelectorAll('.star');
                stars.forEach((star, index) => {
                    const rating = index + 1;
                    if (foodData.rating >= rating) {
                        star.classList.add('filled');
                    } else {
                        star.classList.remove('filled');
                    }
                });
                
                const checkbox = foodElement.querySelector('.tried-checkbox');
                if (checkbox) {
                    checkbox.checked = foodData.tried || false;
                }
            }
        }

        // Update all food displays (for realtime sync)
        function updateAllFoodDisplays() {
            Object.entries(weaningStages).forEach(([stageName, foods]) => {
                foods.forEach(food => {
                    updateFoodItemDisplay(stageName, food);
                });
            });
        }

        // Get food data
        function getFoodData(stageName, foodName) {
            const key = `${stageName}-${foodName}`;
            return weaningData[key] || { tried: false, attempts: 0, rating: 0 };
        }

        // Update food data
        function updateFoodData(stageName, foodName, property, value) {
            const key = `${stageName}-${foodName}`;
            if (!weaningData[key]) {
                weaningData[key] = { tried: false, attempts: 0, rating: 0 };
            }
            weaningData[key][property] = value;
        }

        // Update summary statistics
        function updateSummary() {
            let totalFoods = 0;
            let triedFoods = 0;
            let totalAttempts = 0;
            let totalRatings = 0;
            let ratedFoods = 0;
            let fiveStarFoods = 0;

            Object.entries(weaningStages).forEach(([stageName, foods]) => {
                foods.forEach(food => {
                    totalFoods++;
                    const foodData = getFoodData(stageName, food);
                    
                    if (foodData.tried) triedFoods++;
                    totalAttempts += foodData.attempts || 0;
                    
                    if (foodData.rating > 0) {
                        totalRatings += foodData.rating;
                        ratedFoods++;
                        if (foodData.rating === 5) fiveStarFoods++;
                    }
                });
            });

            document.getElementById('totalTried').textContent = triedFoods;
            document.getElementById('totalAttempts').textContent = totalAttempts;
            document.getElementById('avgRating').textContent = ratedFoods > 0 ? (totalRatings / ratedFoods).toFixed(1) : '0';
            document.getElementById('favoriteFoods').textContent = fiveStarFoods;

            const progressPercent = totalFoods > 0 ? (triedFoods / totalFoods * 100) : 0;
            document.getElementById('progressBar').style.width = `${progressPercent}%`;
            document.getElementById('progressText').textContent = `${Math.round(progressPercent)}% Complete`;
        }

        // Notes functionality
        function setupNotesListener() {
            const notesArea = document.getElementById('notesArea');
            let timeout;
            
            notesArea.addEventListener('input', function() {
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    notes = this.value;
                    saveToFirebase('notes', notes);
                }, 1000);
            });
        }

        // Loading indicator
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // Auto-save indicator
        function showAutoSave(message = '✅ Synced to cloud!') {
            const indicator = document.getElementById('autoSaveIndicator');
            indicator.textContent = message;
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        // Export functionality
        window.exportData = function() {
            const exportData = {
                user: currentUser,
                weaningData: weaningData,
                allergyData: allergyData,
                notes: notes,
                customStages: weaningStages,
                achievements: achievements,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `${currentUser}-weaning-data-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showAutoSave('📥 Data exported successfully!');
        }

        // Import functionality
        window.importData = function() {
            document.getElementById('importFile').click();
        }

        window.handleImport = function(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (importedData.weaningData) {
                            weaningData = importedData.weaningData;
                            saveToFirebase('weaningData', weaningData);
                        }
                        
                        if (importedData.allergyData) {
                            allergyData = importedData.allergyData;
                            saveToFirebase('allergyData', allergyData);
                        }
                        
                        if (importedData.notes) {
                            notes = importedData.notes;
                            document.getElementById('notesArea').value = notes;
                            saveToFirebase('notes', notes);
                        }
                        
                        if (importedData.customStages) {
                            weaningStages = importedData.customStages;
                            saveToFirebase('customStages', weaningStages);
                        }

                        if (importedData.achievements) {
                            achievements = importedData.achievements;
                            saveToFirebase('achievements', achievements);
                        }
                        
                        renderStages();
                        updateSummary();
                        showAutoSave('📤 Data imported and synced!');
                        
                    } catch (error) {
                        alert('Error importing data. Please check the file format.');
                    }
                };
                reader.readAsText(file);
            }
        }

        // Monetization and privacy/cookies handlers removed per user request.

        // Feedback handlers
        // Optional: set a webhook URL here (string) to forward feedback POSTs to a service you control.
        // Leave empty ('') to disable forwarding.
        const FEEDBACK_WEBHOOK = '';

        function setupFeedback() {
            const btn = document.getElementById('feedbackBtn');
            const modal = document.getElementById('feedbackModal');
            const cancel = document.getElementById('feedbackCancel');
            const submit = document.getElementById('feedbackSubmit');
            const status = document.getElementById('feedbackStatus');

            if (!btn || !modal) {
                console.warn('Feedback UI missing elements; feedback disabled');
                return;
            }

            // Ensure modal can be opened even if other scripts threw earlier
            btn.removeEventListener && btn.removeEventListener('click', null);
            btn.addEventListener('click', (e) => {
                e && e.preventDefault();
                try {
                    modal.style.display = 'block';
                    const msg = document.getElementById('feedbackMessage');
                    if (msg) msg.focus();
                } catch (err) { console.error('Could not open feedback modal', err); }
            });

            if (cancel) {
                cancel.addEventListener('click', () => { modal.style.display = 'none'; if (status) status.textContent = ''; });
            }

            if (!submit) return;

            submit.addEventListener('click', async () => {
                const emailEl = document.getElementById('feedbackEmail');
                const messageEl = document.getElementById('feedbackMessage');
                const email = emailEl ? emailEl.value.trim() : '';
                const message = messageEl ? messageEl.value.trim() : '';

                if (!message) {
                    if (status) { status.style.color = '#d9534f'; status.textContent = 'Please enter a message.'; }
                    return;
                }

                submit.disabled = true;
                if (status) { status.style.color = '#6c757d'; status.textContent = 'Sending...'; }

                try {
                    const feedbackRef = ref(database, 'feedback');
                    const payload = {
                        user: currentUser || null,
                        userEmail: email || null,
                        message: message,
                        page: window.location.pathname,
                        date: new Date().toISOString()
                    };

                    const newRef = push(feedbackRef);
                    await set(newRef, payload);

                    // Optionally forward to a webhook if configured
                    if (FEEDBACK_WEBHOOK && typeof FEEDBACK_WEBHOOK === 'string' && FEEDBACK_WEBHOOK.length > 0) {
                        try {
                            // Fire-and-forget; don't block user on webhook failure
                            fetch(FEEDBACK_WEBHOOK, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            }).catch(err => console.warn('Feedback webhook failed', err));
                        } catch (fwErr) { console.warn('Could not forward feedback to webhook', fwErr); }
                    }

                    if (status) {
                        status.style.color = '#28a745';
                        status.textContent = 'Thanks — feedback sent.';
                    }

                    if (messageEl) messageEl.value = '';
                    if (emailEl) emailEl.value = '';

                    setTimeout(() => { try { modal.style.display = 'none'; if (status) status.textContent = ''; } catch(e){} }, 1200);
                } catch (err) {
                    console.error('Feedback send error', err);
                    if (status) { status.style.color = '#d9534f'; status.textContent = 'Could not send feedback. Try again later.'; }
                } finally {
                    submit.disabled = false;
                }
            });
        }

    </script>
    <script>
        // Demo preview: show main app without logging in (non-module fallback)
        (function setupDemoPreview() {
            function init() {
                // About button toggles the overview content
                const aboutBtn = document.getElementById('aboutBtn');
                const overview = document.getElementById('overviewContent');
                if (aboutBtn && overview) {
                    aboutBtn.addEventListener('click', () => {
                        if (overview.style.display === 'none' || !overview.style.display) {
                            overview.style.display = 'block';
                            aboutBtn.textContent = 'Hide overview';
                        } else {
                            overview.style.display = 'none';
                            // only set text if the button still exists
                            if (aboutBtn) aboutBtn.textContent = 'About the app';
                        }
                    });
                }

                const tryBtn = document.getElementById('tryDemoBtn');
                if (!tryBtn) return;

                // Extract demo opening logic so it can be called from the link (?demo=1)
                function openDemo() {
                    try {
                        const loginScreen = document.getElementById('loginScreen');
                        const mainApp = document.getElementById('mainApp');
                        if (loginScreen) loginScreen.style.display = 'none';
                        if (mainApp) {
                            mainApp.style.display = 'block';
                            try { if (typeof renderStages === 'function') renderStages(); } catch(e) { console.warn(e); }
                            try { if (typeof updateSummary === 'function') updateSummary(); } catch(e) {}
                            try { if (typeof setupAddMealTab === 'function') setupAddMealTab(); } catch(e) {}
                        }

                        // Create a back button so users can return to the login screen
                        if (!document.getElementById('demoBackBtn')) {
                            const back = document.createElement('button');
                            back.id = 'demoBackBtn';
                            back.className = 'demo-back-btn';
                            back.textContent = 'Back to login';
                            back.addEventListener('click', () => {
                                try {
                                    // Hide the demo UI locally
                                    if (mainApp) mainApp.style.display = 'none';
                                    if (loginScreen) loginScreen.style.display = 'flex';
                                    // remove the back button
                                    back.remove();
                                            // hide overview content again
                                            if (overview) { overview.style.display = 'none'; if (aboutBtn) aboutBtn.textContent = 'About the app'; }
                                    window._DEMO_PREVIEW = false;
                                    // Navigate the user back to the public landing page so they land where they started
                                    // Navigate back to the login page (login.html)
                                    window.location.href = 'login.html';
                                } catch (e) {
                                    console.error('Failed to navigate back to landing', e);
                                }
                            });

                            // put back button near the top-left of the app header area
                            const header = document.querySelector('.header');
                            if (header) header.appendChild(back);
                        }
                        window._DEMO_PREVIEW = true;
                    } catch (err) { console.error('Demo preview error', err); }
                }

                tryBtn.addEventListener('click', (e) => { e && e.preventDefault(); openDemo(); });

                // If the URL has ?demo=1, auto-open the demo when the page loads
                try {
                    const params = new URLSearchParams(window.location.search || '');
                    if (params.get('demo') === '1') {
                        // Delay slightly to ensure other inits complete
                        setTimeout(openDemo, 100);
                    }
                } catch (err) {
                    // URLSearchParams may fail in some older contexts; ignore
                }
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
        })();
    </script>
</body>
</html>
